\chapter{Динамическое программирование}

\noindent\fbox{
	\parbox{\linewidth}{
		\qquad Динамическое программирование эффективно, если процесс принятия  решения состоит из многих шагов, то есть когда итоговое решение --- последовательность принимаемых решений (\definitionfont{стратегия}). Теоретически с помощью динамического программирования можно решить любую экстремальную задачу, однако практически это не всегда возможно, так как появляется слишком много состояний... \textbf{Главная идея динамического программирования} заключается в том, чтобы не пытаться решить задачу непосредственно, а поместить её в семейство аналогичных задач, среди которых есть просто решаемые.
	}
}

\section{Задача загрузки судна}\label{pr:loading_vessel}

Начнём рассмотрение динамического программирования на примере задачи загрузки судна. Пусть есть грузовое судно и набор различных контейнеров. Требуется загрузить судно контейнерами таким образом, чтобы при их дальнейшей продаже заработать как можно больше, при этом размер грузовой площадки судна ограничен.

\begin{figure}[H]
	\centering
	\def\svgwidth{\linewidth}
	\fbox{\input{./graphics/cargo_ship_1_N.pdf_tex}}
\end{figure}

\bigskip

\textbf{1. Что будем оптимизировать?} Ответ: доход с продажи контейнеров должен быть максимальным.

\bigskip

\textbf{2. Что существенно влияет на оптимизируемую характеристику?}

Пусть $i=1 \dots N$ --- номера контейнеров.

\bigskip

\textit{Параметры}

\begin{itemize}[nosep]
	\item $h_i$ --- место на грузовой площадке, занимаемое контейнером $i$;
	
	\item $c_i$ --- ценность контейнера $i$;
	
	\item $P$ --- размер грузовой площадки судна.
\end{itemize}

\bigskip

\textit{Переменные}
\begin{itemize}[nosep]
	\item $x_i$ --- сколько контейнеров с номером $i$ нужно взять на судно.
\end{itemize}

\bigskip

\textbf{3. Математическая формулировка задачи}

\[
\sum_{i=1}^{N} c_i x_i \to \max_{(x_i), \; i \in \{1, \dots, N\}},
\]
\[
\sum_{i=1}^{N} h_i x_i \le P,
\]
\[
x_i \in \{0, 1, 2, 3, \dots\}, \quad i \in {1, \dots N}.
\]

\solution

Для решения задачи будет рассматривать семейства аналогичных задач. Каждое семейство будут охарактеризовываться парой $(n, p)$, где $p$ --- место на площадке, а $n$ --- минимальный номер для контейнеров, которые у нас есть. То есть вместо рассмотрения исходной задачи про все $N$ контейнеров и всю грузовую площадку размером $P$ будем рассматривать задачи, в которых нам доступны не все контейнеры, а лишь начинающиеся с номера $n \le N$, а также в которых нам доступна не вся грузовая площадка судна, а лишь её часть размером $p \le P$.

\begin{figure}[H]
	\centering
	\def\svgwidth{\linewidth}
	\fbox{\input{./graphics/cargo_ship_n_N.pdf_tex}}
\end{figure}

Запишем целевую функцию и ограничения для данного семейства
\[
\sum_{i=n}^{N} c_i x_i \to \max_{(x_i), \; i=1 \dots N},
\]
\[
\sum_{i=n}^{N} h_i x_i \le p,
\]
\[
x_i \in \{0, 1, 2, 3, \dots\} \quad i = 1 \dots N
\]

Зададимся вопросом: а есть ли в этом семействе задачи, которые можно легко решить? Да, например если $n = N$, то есть если у нас в распоряжении есть лишь контейнер с номером $N$.

\textbf{Введём обозначение}. Пусть $\boxed{f_n(p)}$ --- оптимальное значение целевой функции семейства задач $(n, p)$. По своей сути $f_n(p)$ --- это максимальный доход, который мы получим, если будем на площадку размера $p$ грузить контейнеры с номерами $n, n+1, n+2, \dots, N$.

Легко заметить, что
\[
f_N(p) = c_N \cdot \bigg[\frac{p}{h_N}\bigg].
\]

Действительно, если у нас в распоряжении есть лишь контейнеры с номером $N$, то для получения максимального дохода нужно попытаться по-максимум загрузить ими площадку на грузовом корабле, $\big[\frac{p}{h_N}\big]$ --- количество контейнеров, которое поместится на площадку.

Таким образом, мы уже умеем решать задачу $(N, p)$ для любого $p \le P$. Теперь нужно совершить переход к решению исходной задачи
\[
f_N(p) \longrightarrow f_1(P).
\]

Для этого сформулируем принцип.

\definition[принцип оптимальности для оптимальной стратегии]

\definitionfont{Оптимальная стратегия обладает тем свойством, что каким бы не было первое решение, последующие решения должны образовывать оптимальную стратегию относительно состояния, полученного по итогам первого решения}.

\example

Пусть мы стоим у доски и нам захотелось как можно быстрее выйти из аудитории через дверь. Каким бы ни был наш первый шаг, если мы хотим дойти до двери как можно быстрее, придётся всё время действовать оптимально. То есть даже если первый шаг был оптимальным, но потом мы накосячили и пошли неоптимально, стратегия точно не получится оптимальной.

\returntoproblem

Предположим, что для некоторого $n \le N$ мы умеем уже знаем
\[
f_{n+1}(p), f_{n+2}(p), \dots, f_{N}(p),
\]

однако нам бы хотелось посчитать $f_n(p)$, как это можно сделать? Предположим, что $x_n = x = 1$, тогда груз с номером $n$ даст нам ценность $c_n \cdot x = c_n$ и займёт на площадке место $h_n \cdot x = h_n$. Обобщим для $x_n \neq 1$ и запишем целевую функцию
\[
\boxed{\forall p \le P \qquad f_n(p) = \max_{h_n \cdot x \le p, \; x = 0, 1, 2, \dots} \big\{c_n \cdot x + f_{n+1}(p - h_n \cdot x)\big\}}.
\]

Действительно, оптимальное значение при контейнерах $n, n+1, n+2, \dots, N$ складывается из некоторого количества контейнеров с номером $n$ и контейнерах $n+1, n+2, \dots, N$. Чтобы найти оптимальное значение нужно перебрать все варианты того, сколько взять контейнеров с номером $n$, при этом ясно, что взять их <<слишком много>> не получится, потому что размер площадки ограничен $p$. Это условие отражается через $h_n \cdot x \le p$.

Мы получили \textbf{рекуррентное соотношение динамического программирования}, при этом, как уже говорилось ранее, $f_n(p)$ можно получить перебором значение $x_n = x$, а $f_{n+1}(\dots)$ по предположению нам уже известно.

Почему мы предполагаем, что $f_{n+1}(\dots)$ нам известно? Ранее мы обсуждали, что мы можем вычислить $f_N(p)$ для любого $p \le P$. Значит с помощью рекуррентного соотношения можем вычислить $f_{N_1}(p)$ для любого $p$, после этого можно вычислить $f_{N-2}(p)$ и так далее. То есть, если у нас есть хотя бы одно значение <<в конце>>, то мы можем дойти до <<начала>> за определённое число шагов. Поэтому предположению о том, что на некотором шаге $n$ нам уже известно оптимальное значение $f_{n+1}(p)$ имеет место.

Алгоритм решения задач с помощью динамического программирования разберём дальше на примерах.

\section{$N$-шаговый процесс принятия решений}

Обобщим \hyperref[pr:loading_vessel]{задачу о загрузке судна}, рассмотрев общую задачу. Пусть $N$ --- число шагов в нашем процессе. Исходные данные задачи:

\begin{itemize}[nosep]
	\item $P_i$ --- множество возможных состояний на $i$-ом шаге, $i = 1 \dots N+1$. Шага с номером $N+1$ не будет, поэтому $P_{N+1}$ можно считать фиктивной переменной, введённой для удобства. В рассмотренной ранее задачи множеством наших состояний были числа $p=\{0, 1, 2, \dots, P\}$ --- доступный размер площадки;ы
	
	\item $p_1 = p_0$ --- некоторая известная заданная величина (\textit{начальное состояние});
	
	\item $Q_i$ --- множество возможных решений на $i$-ом шаге, $i = 1 \dots N$;
	
	\item $T_i(p, q)$ --- функция перехода из состояния $p$ в состояние $q$ на $i$-ом шаге, $i = 1 \dots N$;
	
	\item $Q_i(p)$ --- множество допустимых решений на $i$-ом шаге в состоянии $p$, то есть
	\[
	Q_i(p) = \{q \in Q_i \; \big| \; T_i(p, q) \in P_{i+1}\}
	\]	
\end{itemize}

\textbf{Как принять решение?}

Для начала берём $q \in Q_1(p_0)$. Далее на каждом шаге выбираем состояние из множества допустимых состояний. Таким образом мы получим некоторую допустимую стратегию $\{q_1, q_2, \dots, q_n\}$, при этом функция перехода будет каждый раз переводить нас в допустимое решение, то есть
\[
p_{i+1} = T_i(p_i, q_i) \in P_{i+1}.
\]

Однако нам бы не хотелось про не просто допустимую, а оптимальную стратегию. Как понять, что стратегия оптимальна и как её вообще получить?

\section{Задача выбора оптимальной стратегии $N$-шагового процесса}

Нам нужен критерий для оценки оптимальной решения на каждом шаге процесса. Введём $g_i(p, q)$ --- функция дохода на $i$-ом шаге, если мы в находимся состоянии $p$ и принимаем решение $q$. В рамках общей задачи нужно найти
\[
\max_{\{q_1, q_2, \dots, q_N\}} \sum_{i=1}^{N} g_i(p_i, q_i)
\]

с ограничениями
\[
p_1 = p_0,
\]
\[
p_i \in P_i, \quad i \in \{2, \dots, N+1\},
\]
\[
q_i \in Q_i, \quad i \in \{1, \dots, N\},
\]
\[
p_{i+1} = T_i(p_i, q_i), \quad i \in \{1, \dots, N\}.
\]

\bigskip

\textbf{Процесс}

Вновь рассмотрим семейство задач $(n, p)$.
\[
\max_{\{q_n, q_{n+1}, \dots, q_N\}} \sum_{i=n}^{N} g_i(p_i, q_i).
\]

В данных обозначениях исходная задача --- это $f_1(p_0)$. Напишем рекуррентные соотношения в общем виде. Пускай мы знаем как решать задачу при $n = N$
\[
\forall p \in P_{N} \quad f_N(p) = \max_{q \in Q_{N}(p)} g_N(p, q).
\]

Теперь нам нужно осуществить переход от <<простой задачи>> к исходной. Пусть мы находимся на шаге $n$, тогда
\[
f_n(p) = \max_{q \in Q_{n}(p)} \Big[g_n(p, q) + \underbrace{f_{n+1}\big(T_{n}(p, q)\big)}_{\text{уже знаем решение}}\Big].
\]

То есть на каждом шаге будем находить значение $f_n(p)$ для всех возможных состояний $p \in P_n$. На первом шаге $n = N$, на втором шаге --- $(N-1)$, на третьем шаге --- $(N-2)$ и так далее.

По итогам такого процесса мы вычислим $f_1(P)$ --- оптимальное значение целевой функции, однако мы не узнаем, как выглядят оптимальные решения на каждом шаге. То есть мы не узнаем, как нам нужно действовать. Чтобы это исправить будем на каждом шаге помимо $f_n(p)$ будем считать $q_n(p)$ --- значение $q$, на котором достигается максимум в состоянии $p$.

\bigskip

\textbf{Нахождение стратегии}

Мы на каждом шаге для всех состояний посчитали значение $f_n(p)$ и $q_n(p)$. Будем находить оптимальную стратегию следующим образом
\begin{align*}
	p_1^* = p_0&, \qquad &q_1^* = q_1(p_1^*), \\
	p_2^* = T_1(p_1^*, q_1^*)&, &q_2^* = q_2(p_2^*), \\
	p_3^* = T_2(p_2^*, q_2^*)&, &q_3^* = q_3(p_3^*), \\
	\dots& &\dots \\
	p_N^* = T_{N_1}(p_{N_1}^*, q_{N_1}^*)&, &q_N^* = q_N(p_N^*).
\end{align*}

То есть на каждом шаге будем вычислять оптимальное значение $q_i^*$ по состоянию $p_i^*$ и посчитанным значениям $q_i(p)$. Совокупность всех значений $\{q_i^*\}_{i=1}^{N}$ и будет нашей оптимальной стратегией. Однако почему эта стратегия будет оптимальной?

\bigskip

\textbf{Доказательство оптимальности стратегии}

Итак, имеем стратегию $\{q_1^*, q_2^*, \dots, q_N^*\}$ --- стратегия. Докажем, что она оптимальна. Докажем, что
\[
f_1(p_0) = \sum_{i=1}^N g_i(p_i^*, q_i^*).
\]

Имеем
\[
f_1(p_0) \stackrel{def}{=} f_1(p_1^*) = \max_{q \in Q_{1}(p_1^*)} \Big[g_1(p_1^*, q) + f_{2}\big(T_{1}(p_1^*, q)\big)\Big]
\]

По построению максимум при $n=1$ происходит при $q = q_1^* = q_1(p_1^*)$, поэтому
\begin{align*}
	f_1(p_0) =& \; \max_{q \in Q_{1}(p_1^*)} \Big[g_1(p_1^*, q) + f_{2}\big(T_{1}(p_1^*, q)\big)\Big] \\
	=& \; g_1(p_1^*, q_1^*) + f_{2}\big(T_{1}(p_1^*, q_1^*)\big) \\
	\stackrel{def}{=}& \; g_1(p_1^*, q_1^*) + f_2(p_2^*) \\
	=& \; g_1(p_1^*, q_1^*) + \max_{q \in Q_{2}(p_2^*)} \Big[g_2(p_2^*, q) + f_{3}\big(T_{2}(p_2^*, q)\big)\Big].
\end{align*}

По построению максимум при $n=2$ происходит при $q = q_2^* = q_2(p_2^*)$, поэтому
\begin{align*}
	f_1(p_0) =& \; g_1(p_1^*, q_1^*) + \max_{q \in Q_{2}(p_2^*)} \Big[g_2(p_2^*, q) + f_{3}\big(T_{2}(p_2^*, q)\big)\Big] \\
	=& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + f_{3}\big(T_{2}(p_2^*, q_2^*)\big) \\
	\stackrel{def}{=}& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + f_3(p_3^*) \\
	=& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + \max_{q \in Q_{3}(p_3^*)} \Big[g_3(p_3^*, q) + f_{4}\big(T_{3}(p_3^*, q)\big)\Big].
\end{align*}

Рассуждая аналогично, можно получить, что
\begin{align*}
	f_1(p_0) =& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + g_3(p_3^*, q_3^*) + \dots + g_N(p_N^*, q_N^*) \\
	=& \; \sum_{i=1}^N g_i(p_i^*, q_i^*).
\end{align*}

Требуемое доказано, а значит исходная стратегия является оптимальной.

\subsection{Решение задачи о машине на острове}

Решим \hyperref[pr:car_on_island]{задачу о машине на острове} с помощью $N$-шагового процесса принятия решения. Немного изменим обозначения исходной задачи. Пусть $i = 1 \dots n$ --- вид детали.

\textit{Параметры}

\begin{itemize}[nosep]
	\item $h = \{m_i\}_{i=1}^n$ --- масса деталей;
	
	\item $t = \{t_i\}_{i=1}^n$ --- срок службы деталей;
	
	\item $d = \{a_i\}_{i=1}^n$ --- количество работающих деталей в машине;
	
	\item $P$ --- максимальная масса посылки.
\end{itemize}

\bigskip

\textit{Переменные}

\begin{itemize}[nosep]	
	\item $x = \{x_i\}_{i=1}^n$ --- сколько нужно взять деталей в посылку.
\end{itemize}

\textit{Динамическое программирование}

\begin{itemize}[nosep]
	\item \underline{количество шагов процесса} = количество видов деталей = $N$;
	
	\item \underline{на $i$-ом шаге} будем определять, сколько деталей $i$-го типа нужно взять в посылку;
	
	\item \underline{текущее состояние} --- свободная масса груза в посылке, то есть сколько ещё массы можно использовать.
\end{itemize}

\bigskip

Будем рассматривать семейства задач, которые определяются парой $(n, p)$. Фактически это означает, что у нас в распоряжении
\begin{itemize}[nosep]
	\item есть детали не всех видов, а лишь от $n$ до $N$, $n \le N$;
	
	\item есть не вся масса посылки $P$, а лишь её часть $p \le P$.
\end{itemize}

\bigskip

\textbf{База процесса}

Пусть $f_n(p)$ --- максимальное время, которое проработает машина в семействе задач $(n, p)$. Заметим, что если $n = N$, то задача легко решается
\[
\forall p \le P \quad f_N(p) = \bigg(d_N + \bigg[\frac{p}{h_N}\bigg]\bigg) \cdot t_N
\]

В таком случае решение состоит в том, что нужно заказать детали вида $N$ на максимум, то есть сколько можем, столько и заказываем.

\bigskip

\textbf{Переход}

Теперь когда у нас база для решения задачи, осуществим переход $f_{n+1} \to f_n(p)$ в предположении, что $f_{n+1}(p)$ мы знаем $\forall p \le P$.
\[
\boxed{f_n(p) = \max_{\stackrel{x = x_n}{h_n \cdot x \le p, \; x \ge 0}} \min\Big\{(d_n + x) \cdot t_n \; ; \; f_{n+1}(p - x \cdot h_n)\Big\}}
\]

$(d_n + x) \cdot t_n$ --- это сколько проработают детали $n$-го вида с учётом уже имеющихся в машине и тех, которые будут заказаны. Для решения задачи нужно для всех $p \le P$ найти значение $f_n(p)$ и соответствующие значения $x$, на которых максимум и достигается.

В исходной формулировке у нас было

\[
f_n(p) = \max_{q \in Q_{n}(p)} \Big[g_n(p, q) + f_{n+1}\big(T_{n}(p, q)\big)\Big].
\]

Отличие в данной задаче состоит в том, что у нас в рекуррентном соотношении не суммирование, а взятие минимума. Теоретически здесь может быть и умножение, но большой роли при решении это не играет. Важно, что рекуррентное соотношение написано.

\bigskip

\textbf{Конкретная задача}

Решим задачу с конкретными числовыми данными

\begin{itemize}[nosep]
	\item $N = 4$;
	
	\item $h = \{3, 2, 3, 2\}$ кг;
	
	\item $t = \{6, 3, 2, 4\}$ дней;
	
	\item $d = \{1.5, 1.5, 1.5, 1.5\}$. $d_i$ = 1.5 может означать, например, что в машине установлены две детали вида $i$, при этом одна отработала половину своего срока, а вторую только недавно установили;
	
	\item $P = 8$ кг.
\end{itemize}

\bigskip

В ходе решения задачи будем заполнять следующую таблицу

\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
		\hline
		0 & & & & \\\hline
		1 & & & & \\\hline
		2 & & & &\\\hline
		3 & & & & \\\hline
		4 & & & & \\\hline
		5 & & & & \\\hline
		6 & & & & \\\hline
		7 & & & & \\\hline
		8 & & & & \\\hline
	\end{tabular}
\end{table}

Таблицу будем заполнять справа налево, запоминая $q_i$ --- то значение $x$, на котором достигается максимум целевой функции.

В левом столбце у нас все возможные состояния $p$, а $p$ --- свободная масса груза в посылке. Заметим, что ни на каком шаге $p$ не может равняться 7, то есть какие бы грузы мы не клали в посылку, свободная масса груза не сможет равняться 7. Это означает, что можно не подсчитывать значения для $p = 7$.

\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
		\hline
		0 & & & & \\\hline
		1 & & & & \\\hline
		2 & & & &\\\hline
		3 & & & & \\\hline
		4 & & & & \\\hline
		5 & & & & \\\hline
		6 & & & & \\\hline
		7 & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
		8 & & & & \\\hline
	\end{tabular}
\end{table}

\begin{enumerate}
	\item[\fbox{\textbf{Шаг 1}}] На первом шаге $n = N = 4$, запишем выражение для $f_4(p)$
	
	\[
	f_4(p) = \bigg(d_n + \bigg[\frac{p}{h_4}\bigg]\bigg) \cdot t_4 = \bigg(1.5 + \bigg[\frac{p}{2}\bigg]\bigg) \cdot 4.
	\]
	
	Таким образом мы можем посчитать значение $f_4(p)$ для любого $p \le P$, при этом нам известно значение, на котором достигается максимум ($q_4$)
	\[
	q_4 = \bigg[\frac{p}{2}\bigg].
	\]
	
	
	Посчитаем значение $f_4$ для всех возможных состояний
	\[
	f_4(0) = 6, \quad q_4 = \bigg[\frac{0}{2}\bigg] = 0;
	\]
	\[
	f_4(1) = 6, \quad q_4 = \bigg[\frac{1}{2}\bigg] = 0;
	\]
	\[
	f_4(2) = 10, \quad q_4 = \bigg[\frac{2}{2}\bigg] = 1;
	\]
	\[
	f_4(3) = 10 \quad q_4 = \bigg[\frac{3}{2}\bigg] = 1;
	\]
	\[
	f_4(4) = 14, \quad q_4 = \bigg[\frac{4}{2}\bigg] = 2;
	\]
	\[
	f_4(5) = 14, \quad q_4 = \bigg[\frac{5}{2}\bigg] = 2;
	\]
	\[
	f_4(6) = 18, \quad q_4 = \bigg[\frac{6}{2}\bigg] = 3;
	\]
	\[
	f_4(8) = 22, \quad q_4 = \bigg[\frac{8}{2}\bigg] = 4.
	\]
	
	Занесём все эти данные в последний столбец таблицы.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & & & & $(6, 0)$ \\\hline
			1 & & & & $(6, 0)$ \\\hline
			2 & & & & $(10, 1)$ \\\hline
			3 & & & & $(10, 1)$ \\\hline
			4 & & & & $(14, 2)$ \\\hline
			5 & & & & $(14, 2)$ \\\hline
			6 & & & & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & & & & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 2}}] На втором шаге $n = 3$. Запишем выражение для $f_3(p)$
	
	\begin{align*}
		f_3(p) =& \max_{\stackrel{x = x_3}{h_3 \cdot x \le p, \; x \ge 0}} \min\Big\{(d_3 + x) \cdot t_3 \; ; \; f_{4}(p - x \cdot h_3)\Big\} \\
		=& \max_{\stackrel{x = x_3}{3x \le p, \; x \ge 0}} \min\Big\{3 + 2x \; ; \; f_{4}(p - 3x)\Big\}
	\end{align*}
	
	На данном шаге нам нужно для всех $0 \le p \le P$ вычислить значение $f_3(p)$ и запомнить значение $x$, на котором достигается максимум в каждом конкретном состоянии. Для каждого состояния мы будем перебирать различные значения $x$. Для примера найдём $f_3(8)$. Для этого нам нужно перебрать значения $x \in \{0, 1, 2\}$, поскольку при $x > 2$ неравенство $3x \le 8$ уже не выполняется, а $x < 0$ нам не подходят по условию. Вычислим значение $\min$ для каждого из этих трёх значений $x$
	
	\[
	x = 0: \quad \min\big\{3 + 2 \cdot 0 \; ; \; f_4(8)\big\} = \min\{3, 22\} = 3
	\]
	\[
	x = 1: \quad \min\big\{3 + 2 \cdot 1 \; ; \; f_4(5)\big\} = \min\{5, 14\} = 5
	\]
	\[
	x = 2: \quad \min\big\{3 + 2 \cdot 2 \; ; \; f_4(2)\big\} = \min\{7, 10\} = \circled{7}
	\]
	
	То есть мы рассмотрели три разных значения $x$ (0, 1, 2), для каждого из них вычислили значение $\min\Big\{(d_n + x) \cdot t_n \; ; \; f_{n+1}(p - x \cdot h_n)\Big\}$, а после этого выбрали из трёх итоговых значение максимальное --- 7, при этом запомнили, что это значение достигается при $x = 2$. Однако данные вычисления можно записать существенно короче
	\[
	f_3(8) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(8) = 22\} = 3 \\
		1 & \{5 \; ; \; f_4(8) = 14\} = 5 \\
		2 & \{7 \; ; \; f_4(8) = 10\} = \circled{7}
	\end{array}
	\]
	
	В первом столбце у нас идут перебираемые значения $x$, а далее для каждого из них вычисление $\min$, само слово <<min>> писать здесь излишне. В кружок обведено значение $\max$. Данной нотации и будем придерживаться всюду далее. Посчитаем $f_3(p)$ для всех $p$
	
	\[
	f_3(0) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(0) = 6\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_3(1) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(1) = 6\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_3(2) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(2) = 10\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_3(3) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(3) = 10\} = 3 \\
		1 & \{5 \; ; \; f_4(0) = 6\} = \circled{5}
	\end{array}
	\]
	
	\[
	f_3(4) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(4) = 14\} = 3 \\
		1 & \{5 \; ; \; f_4(1) = 6\} = \circled{5}
	\end{array}
	\]
	
	\[
	f_3(5) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(5) = 14\} = 3 \\
		1 & \{5 \; ; \; f_4(2) = 10\} = \circled{5}
	\end{array}
	\]
	
	\[
	f_3(6) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(6) = 18\} = 3 \\
		1 & \{5 \; ; \; f_4(3) = 10\} = 5 \\
		2 & \{7 \; ; \; f_4(0) = 6\} = \circled{6}
	\end{array}
	\]
	
	\[
	f_3(8) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(8) = 22\} = 3 \\
		1 & \{5 \; ; \; f_4(3) = 10\} = 5 \\
		2 & \{7 \; ; \; f_4(2) = 10\} = \circled{7}
	\end{array}
	\]
	
	Занесём все данные в таблицу. В столбец $(f_3, q_3)$ возле максимального значения, обведённого в кружочек, для каждого состояния $p$ мы ещё записываем значение $x$, в котором достигается максимум. Так, для $f_3(8)$ это $x = 2$, для $f_3(5)$ это $x = 1$ и так далее.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & & & $(3, 0)$ & $(6, 0)$ \\\hline
			1 & & & $(3, 0)$ & $(6, 0)$ \\\hline
			2 & & & $(3, 0)$ & $(10, 1)$ \\\hline
			3 & & & $(5, 1)$ & $(10, 1)$ \\\hline
			4 & & & $(5, 1)$ & $(14, 2)$ \\\hline
			5 & & & $(5, 1)$ & $(14, 2)$ \\\hline
			6 & & & $(6, 2)$ & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & & & $(7, 2)$ & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 3}}] На третьем шаге $n = 2$. Запишем выражение для $f_2(p)$
	
	\begin{align*}
		f_2(p) =& \max_{\stackrel{x = x_2}{h_2 \cdot x \le p, \; x \ge 0}} \min\Big\{(d_2 + x) \cdot t_2 \; ; \; f_{3}(p - x \cdot h_2)\Big\} \\
		=& \max_{\stackrel{x = x_2}{2x \le p, \; x \ge 0}} \min\Big\{4.5 + 3x \; ; \; f_{3}(p - 2x)\Big\}
	\end{align*}
	
	Посчитаем $f_2(p)$ для всех $p$
	
	\[
	f_2(0) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(0) = 3\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_2(1) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(1) = 3\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_2(2) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(2) = 3\} = \circled{3} \\
		1 & \{7.5 \; ; \; f_3(0) = 3\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_2(3) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(3) = 5\} = \circled{4.5} \\
		1 & \{7.5 \; ; \; f_3(1) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(4) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(4) = 5\} = \circled{4.5} \\
		1 & \{7.5 \; ; \; f_3(2) = 3\} = 3 \\
		2 & \{10.5 \; ; \; f_3(0) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(5) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(5) = 5\} = 4.5 \\
		1 & \{7.5 \; ; \; f_3(3) = 5\} = \circled{5} \\
		2 & \{10.5 \; ; \; f_3(1) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(6) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(6) = 6\} = 4.5 \\
		1 & \{7.5 \; ; \; f_3(4) = 5\} = \circled{5} \\
		2 & \{10.5 \; ; \; f_3(2) = 3\} = 3 \\
		3 & \{13.5 \; ; \; f_3(0) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(8) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(8) = 7\} = 4.5 \\
		1 & \{7.5 \; ; \; f_3(6) = 6\} = \circled{6} \\
		2 & \{10.5 \; ; \; f_3(4) = 5\} = 5 \\
		3 & \{13.5 \; ; \; f_3(2) = 3\} = 3 \\
		4 & \{16.5 \; ; \; f_3(0) = 3\} = 3
	\end{array}
	\]
	
	Занесём все данные в таблицу. Заметим, что при вычислении $f_2(2) = 3$ максимум достигается и при $x = 0$, и при $x = 1$. В таблице это будет отражено как $(3, 0/1)$.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			1 & & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			2 & & $(3, 0/1)$ & $(3, 0)$ & $(10, 1)$ \\\hline
			3 & & $(4.5, 0)$ & $(5, 1)$ & $(10, 1)$ \\\hline
			4 & & $(4.5, 0)$ & $(5, 1)$ & $(14, 2)$ \\\hline
			5 & & $(5, 0)$   & $(5, 1)$ & $(14, 2)$ \\\hline
			6 & & $(5, 1)$   & $(6, 2)$ & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & & $(6, 1)$   & $(7, 2)$ & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 4}}] На четвёртом шаге $n = 1$
	
	Наша исходная задача --- это $f_1(8)$, поэтому для всех остальных значений $p \neq 8$ искать $f_1(p)$ не нужно. Запишем выражение для $f_1(8)$
	
	\begin{align*}
		f_1(8) =& \max_{\stackrel{x = x_1}{h_1 \cdot x \le 8, \; x \ge 0}} \min\Big\{(d_1 + x) \cdot t_1 \; ; \; f_{2}(8 - x \cdot h_1)\Big\} \\
		=& \max_{\stackrel{x = x_1}{3x \le 8, \; x \ge 0}} \min\Big\{9 + 6x \; ; \; f_{2}(8 - 3x)\Big\}
	\end{align*}
	
	Посчитаем $f_1(8)$
	\[
	f_1(8) = \begin{array}{c|l}
		0 & \{9 \; ; \; f_2(8) = 6\} = \circled{6} \\
		1 & \{15 \; ; \; f_2(5) = 5\} = 5 \\
		2 & \{21 \; ; \; f_2(2) = 3\} = 5
	\end{array}
	\]
	
	Занесём данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & $\times$ & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			1 & $\times$ & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			2 & $\times$ & $(3, 0/1)$ & $(3, 0)$ & $(10, 1)$ \\\hline
			3 & $\times$ & $(4.5, 0)$ & $(5, 1)$ & $(10, 1)$ \\\hline
			4 & $\times$ & $(4.5, 0)$ & $(5, 1)$ & $(14, 2)$ \\\hline
			5 & $\times$ & $(5, 0)$   & $(5, 1)$ & $(14, 2)$ \\\hline
			6 & $\times$ & $(5, 1)$   & $(6, 2)$ & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & $(6, 0)$ & $(6, 1)$   & $(7, 2)$ & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	Вспомним, что $f_1(8)$ --- максимальное время работы машины для исходной задачи. Поскольку мы получили, что $f_1(8) = 6$, то в исходной задаче после заказа груза машина проработает ещё 6 дней.
	
	\bigskip
	
	\textbf{Поиск оптимальной стратегии}
	
	Заметим, что наше начальное состояние $p_0 = 8$, поскольку в самом начале нам доступна вся масса груза $P = 8$ кг.
	
	\begin{align*}
		p_1^* = p_0 = 8&, \qquad &q_1^* = 0, \\
		p_2^* = p_1^* - h_1 \cdot q_1^* = 8 &, &q_2^* = 1, \\
		p_3^* = p_2^* - h_2 \cdot q_2^* = 6&, &q_3^* = 2, \\
		p_4^* = p_3^* - h_3 \cdot q_3^* = 0&, &q_4^* = 0.
	\end{align*}
	
	То есть наша стратегия --- это $x^* = \{0, 1, 2, 0\}$. При данной стратегии машина проработает ещё 6 дней. При любых других стратегиях время работы будет меньше.
\end{enumerate}

\remark

Чтобы заполнять меньше значений таблицы можно было в начале прибегнуть к оптимизации, посчитав множество возможных состояний для каждого шага. Тогда бы мы считали на шаге $i$ значения $f_i(p)$ не для всех $p \le P$, а лишь для этих самых возможных состояний.

Например, можно заметить, что для подсчёта $f_1(8)$ нам нужно было знать лишь $f_2(8)$, $f_2(5)$ и $f_2(2)$. Значение $f_2(p)$ для остальных $p$ нам в итоге вообще не пригодились.
