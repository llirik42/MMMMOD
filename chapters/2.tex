\chapter{Динамическое программирование}

\noindent\fbox{
	\parbox{\linewidth}{
		\qquad Динамическое программирование эффективно, если процесс принятия  решения состоит из многих шагов, то есть когда итоговое решение --- последовательность принимаемых решений (\definitionfont{стратегия}). Теоретически с помощью динамического программирования можно решить любую экстремальную задачу, однако практически это не всегда возможно, так как появляется слишком много состояний... \textbf{Главная идея динамического программирования} заключается в том, чтобы не пытаться решить задачу непосредственно, а поместить её в семейство аналогичных задач, среди которых есть просто решаемые.
	}
}

\section{Задача загрузки судна}\label{pr:loading_vessel}

Начнём рассмотрение динамического программирования на примере задачи загрузки судна. Пусть есть грузовое судно и набор различных контейнеров. Требуется загрузить судно контейнерами таким образом, чтобы при их дальнейшей продаже заработать как можно больше, при этом размер грузовой площадки судна ограничен.

\begin{figure}[H]
	\centering
	\def\svgwidth{\linewidth}
	\fbox{\input{./graphics/cargo_ship_1_N.pdf_tex}}
\end{figure}

\bigskip

\textbf{1. Что будем оптимизировать?} Ответ: доход с продажи контейнеров должен быть максимальным.

\bigskip

\textbf{2. Что существенно влияет на оптимизируемую характеристику?}

Пусть $i=1 \dots N$ --- номера контейнеров.

\bigskip

\textit{Параметры}

\begin{itemize}[nosep]
	\item $h_i$ --- место на грузовой площадке, занимаемое контейнером $i$;
	
	\item $c_i$ --- ценность контейнера $i$;
	
	\item $P$ --- размер грузовой площадки судна.
\end{itemize}

\bigskip

\textit{Переменные}
\begin{itemize}[nosep]
	\item $x_i$ --- сколько контейнеров с номером $i$ нужно взять на судно.
\end{itemize}

\bigskip

\textbf{3. Математическая формулировка задачи}

\[
\sum_{i=1}^{N} c_i x_i \to \max_{(x_i), \; i \in \{1, \dots, N\}},
\]
\[
\sum_{i=1}^{N} h_i x_i \le P,
\]
\[
x_i \in \{0, 1, 2, 3, \dots\}, \quad i \in {1, \dots N}.
\]

\solution

Для решения задачи будет рассматривать семейства аналогичных задач. Каждое семейство будут охарактеризовываться парой $(n, p)$, где $p$ --- место на площадке, а $n$ --- минимальный номер для контейнеров, которые у нас есть. То есть вместо рассмотрения исходной задачи про все $N$ контейнеров и всю грузовую площадку размером $P$ будем рассматривать задачи, в которых нам доступны не все контейнеры, а лишь начинающиеся с номера $n \le N$, а также в которых нам доступна не вся грузовая площадка судна, а лишь её часть размером $p \le P$.

\begin{figure}[H]
	\centering
	\def\svgwidth{\linewidth}
	\fbox{\input{./graphics/cargo_ship_n_N.pdf_tex}}
\end{figure}

Запишем целевую функцию и ограничения для данного семейства
\[
\sum_{i=n}^{N} c_i x_i \to \max_{(x_i), \; i=1 \dots N},
\]
\[
\sum_{i=n}^{N} h_i x_i \le p,
\]
\[
x_i \in \{0, 1, 2, 3, \dots\} \quad i = 1 \dots N
\]

Зададимся вопросом: а есть ли в этом семействе задачи, которые можно легко решить? Да, например если $n = N$, то есть если у нас в распоряжении есть лишь контейнер с номером $N$.

\textbf{Введём обозначение}. Пусть $\boxed{f_n(p)}$ --- оптимальное значение целевой функции семейства задач $(n, p)$. По своей сути $f_n(p)$ --- это максимальный доход, который мы получим, если будем на площадку размера $p$ грузить контейнеры с номерами $n, n+1, n+2, \dots, N$.

Легко заметить, что
\[
f_N(p) = c_N \cdot \bigg[\frac{p}{h_N}\bigg].
\]

Действительно, если у нас в распоряжении есть лишь контейнеры с номером $N$, то для получения максимального дохода нужно попытаться по-максимум загрузить ими площадку на грузовом корабле, $\big[\frac{p}{h_N}\big]$ --- количество контейнеров, которое поместится на площадку.

Таким образом, мы уже умеем решать задачу $(N, p)$ для любого $p \le P$. Теперь нужно совершить переход к решению исходной задачи
\[
f_N(p) \longrightarrow f_1(P).
\]

Для этого сформулируем принцип.

\definition[принцип оптимальности для оптимальной стратегии]

\definitionfont{Оптимальная стратегия обладает тем свойством, что каким бы не было первое решение, последующие решения должны образовывать оптимальную стратегию относительно состояния, полученного по итогам первого решения}.

\example

Пусть мы стоим у доски и нам захотелось как можно быстрее выйти из аудитории через дверь. Каким бы ни был наш первый шаг, если мы хотим дойти до двери как можно быстрее, придётся всё время действовать оптимально. То есть даже если первый шаг был оптимальным, но потом мы накосячили и пошли неоптимально, стратегия точно не получится оптимальной.

\returntoproblem

Предположим, что для некоторого $n \le N$ мы умеем уже знаем
\[
f_{n+1}(p), f_{n+2}(p), \dots, f_{N}(p),
\]

однако нам бы хотелось посчитать $f_n(p)$, как это можно сделать? Предположим, что $x_n = x = 1$, тогда груз с номером $n$ даст нам ценность $c_n \cdot x = c_n$ и займёт на площадке место $h_n \cdot x = h_n$. Обобщим для $x_n \neq 1$ и запишем целевую функцию
\[
\boxed{\forall p \le P \qquad f_n(p) = \max_{h_n \cdot x \le p, \; x = 0, 1, 2, \dots} \big\{c_n \cdot x + f_{n+1}(p - h_n \cdot x)\big\}}.
\]

Действительно, оптимальное значение при контейнерах $n, n+1, n+2, \dots, N$ складывается из некоторого количества контейнеров с номером $n$ и контейнерах $n+1, n+2, \dots, N$. Чтобы найти оптимальное значение нужно перебрать все варианты того, сколько взять контейнеров с номером $n$, при этом ясно, что взять их <<слишком много>> не получится, потому что размер площадки ограничен $p$. Это условие отражается через $h_n \cdot x \le p$.

Мы получили \textbf{рекуррентное соотношение динамического программирования}, при этом, как уже говорилось ранее, $f_n(p)$ можно получить перебором значение $x_n = x$, а $f_{n+1}(\dots)$ по предположению нам уже известно.

Почему мы предполагаем, что $f_{n+1}(\dots)$ нам известно? Ранее мы обсуждали, что мы можем вычислить $f_N(p)$ для любого $p \le P$. Значит с помощью рекуррентного соотношения можем вычислить $f_{N_1}(p)$ для любого $p$, после этого можно вычислить $f_{N-2}(p)$ и так далее. То есть, если у нас есть хотя бы одно значение <<в конце>>, то мы можем дойти до <<начала>> за определённое число шагов. Поэтому предположению о том, что на некотором шаге $n$ нам уже известно оптимальное значение $f_{n+1}(p)$ имеет место.

Алгоритм решения задач с помощью динамического программирования разберём дальше на примерах.

\section{$N$-шаговый процесс принятия решений}\label{n_step_process}

Обобщим \hyperref[pr:loading_vessel]{задачу о загрузке судна}, рассмотрев общую задачу. Пусть $N$ --- число шагов в нашем процессе. Исходные данные задачи:

\begin{itemize}[nosep]
	\item $P_i$ --- множество возможных состояний на $i$-ом шаге, $i = 1 \dots N+1$. Шага с номером $N+1$ не будет, поэтому $P_{N+1}$ можно считать фиктивной переменной, введённой для удобства. В рассмотренной ранее задачи множеством наших состояний были числа $p=\{0, 1, 2, \dots, P\}$ --- доступный размер площадки;
	
	\item $p_1 = p_0$ --- некоторая известная заданная величина (\textit{начальное состояние});
	
	\item $Q_i$ --- множество возможных решений на $i$-ом шаге, $i = 1 \dots N$;
	
	\item $T_i(p, q)$ --- функция перехода в другое состояние, если на $i$-ом шаге в состоянии $p$ принимается решение $q$;
	
	\item $Q_i(p)$ --- множество допустимых решений на $i$-ом шаге в состоянии $p$, то есть
	\[
	Q_i(p) = \{q \in Q_i \; \big| \; T_i(p, q) \in P_{i+1}\}
	\]	
\end{itemize}

\bigskip

\textbf{Как принять решение?}

Для начала берём $q \in Q_1(p_0)$. Далее на каждом шаге выбираем состояние из множества допустимых состояний. Таким образом мы получим некоторую допустимую стратегию $\{q_1, q_2, \dots, q_n\}$, при этом функция перехода будет каждый раз переводить нас в допустимое решение, то есть
\[
p_{i+1} = T_i(p_i, q_i) \in P_{i+1}.
\]

Однако нам бы не хотелось про не просто допустимую, а оптимальную стратегию. Как понять, что стратегия оптимальна и как её вообще получить?

\remark

$N$-шаговый процесс удобно использовать, когда понятно, что будет состоянием, какие будут шаги и как будет осуществляться переход от одного состояния к другому. Также важно, чтобы имела место \definitionfont{сепарабельность}, то есть тот факт, что функция дохода может быть посчитана на каждом шаге отдельно, то есть что эффект на целевую функцию на каждом шаге отделён от эффекта на неё на других шагах.

\remark

Иногда при решении задачи в качестве состояния на каждом шаге нужно выбрать не само значение $p_i$, а пару $(q_{i-1}, p_i)$, чтобы знать, какое было принято решение на предыдущем шаге. Это может быть полезно, если за <<не сбалансированые>> решения предусмотрено штрафы. Например, если стратегия <<потратить в этом году все деньги, а в следующем не потратить ничего>> нас не устраивает.

\section{Задача выбора оптимальной стратегии $N$-шагового процесса}\label{n_step_opt}

Нам нужен критерий для оценки оптимальной решения на каждом шаге процесса. Введём $g_i(p, q)$ --- \underline{функция дохода} на $i$-ом шаге, если мы в находимся состоянии $p$ и принимаем решение $q$. В рамках общей задачи нужно найти
\[
\max_{\{q_1, q_2, \dots, q_N\}} \sum_{i=1}^{N} g_i(p_i, q_i)
\]

с ограничениями
\[
p_1 = p_0,
\]
\[
p_i \in P_i, \quad i \in \{2, \dots, N+1\},
\]
\[
q_i \in Q_i, \quad i \in \{1, \dots, N\},
\]
\[
p_{i+1} = T_i(p_i, q_i), \quad i \in \{1, \dots, N\}.
\]

\bigskip

\textbf{$N$-шаговый процесс}

Вновь рассмотрим семейство задач $(n, p)$.
\[
\max_{\{q_n, q_{n+1}, \dots, q_N\}} \sum_{i=n}^{N} g_i(p_i, q_i).
\]

В данных обозначениях исходная задача --- это $f_1(p_0)$. Напишем рекуррентные соотношения в общем виде. Пускай мы знаем как решать задачу при $n = N$
\[
\forall p \in P_{N} \quad f_N(p) = \max_{q \in Q_{N}(p)} g_N(p, q).
\]

Теперь нам нужно осуществить переход от <<простой задачи>> к исходной. Пусть мы находимся на шаге $n$, тогда
\[
f_n(p) = \max_{q \in Q_{n}(p)} \Big[g_n(p, q) + \underbrace{f_{n+1}\big(T_{n}(p, q)\big)}_{\text{уже знаем решение}}\Big].
\]

То есть на каждом шаге будем находить значение $f_n(p)$ для всех возможных состояний $p \in P_n$. На первом шаге $n = N$, на втором шаге --- $(N-1)$, на третьем шаге --- $(N-2)$ и так далее.

По итогам такого процесса мы вычислим $f_1(P)$ --- оптимальное значение целевой функции, однако мы не узнаем, как выглядят оптимальные решения на каждом шаге. То есть мы не узнаем, как нам нужно действовать. Чтобы это исправить на каждом шаге помимо $f_n(p)$ будем считать $q_n(p)$ --- значение $q$, на котором достигается максимум в состоянии $p$. Всё это удобно записывать в таблицу следующего вида
\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & \dots & $(f_n, q_n)$ & $(f_{n+1}, q_{n+1})$ & \dots & $(f_{N-1}, q_{N-1})$ & $(f_N, q_N)$ \\ 
		\hline
		0 & & & & & & & & \\\hline
		1 & & & & & & & & \\\hline
		$\dots$ & & & & & & & & \\\hline
		$P$ & & & & & & & & \\\hline
		$\dots$ & & & & & & & & \\\hline
	\end{tabular}
\end{table}

В первом столбце таблицы представлены все возможные состояния, а в остальных --- значения $f_i(p)$ и $q_i(p)$ на каждом шаге для каждого состояния $p$.

\bigskip

\textbf{Нахождение стратегии}

Мы на каждом шаге для всех состояний посчитали значение $f_n(p)$ и $q_n(p)$. Будем находить оптимальную стратегию следующим образом
\begin{align*}
	p_1^* = p_0&, \qquad &q_1^* = q_1(p_1^*), \\
	p_2^* = T_1(p_1^*, q_1^*)&, &q_2^* = q_2(p_2^*), \\
	p_3^* = T_2(p_2^*, q_2^*)&, &q_3^* = q_3(p_3^*), \\
	\dots& &\dots \\
	p_N^* = T_{N_1}(p_{N_1}^*, q_{N_1}^*)&, &q_N^* = q_N(p_N^*).
\end{align*}

То есть на каждом шаге будем вычислять оптимальное значение $q_i^*$ по состоянию $p_i^*$ и посчитанным значениям $q_i(p)$. Совокупность всех значений $\{q_i^*\}_{i=1}^{N}$ и будет нашей стратегией. Однако почему эта стратегия будет оптимальной?

\bigskip

\textbf{Доказательство оптимальности стратегии}

Итак, имеем стратегию $q = \{q_1^*, q_2^*, \dots, q_N^*\}$. Докажем, что она оптимальна, то есть
\[
f_1(p_0) = \sum_{i=1}^N g_i(p_i^*, q_i^*).
\]

Имеем
\[
f_1(p_0) \stackrel{def}{=} f_1(p_1^*) = \max_{q \in Q_{1}(p_1^*)} \Big[g_1(p_1^*, q) + f_{2}\big(T_{1}(p_1^*, q)\big)\Big]
\]

По построению максимум при $n=1$ происходит при $q = q_1^* = q_1(p_1^*)$, поэтому
\begin{align*}
	f_1(p_0) =& \; \max_{q \in Q_{1}(p_1^*)} \Big[g_1(p_1^*, q) + f_{2}\big(T_{1}(p_1^*, q)\big)\Big] \\
	=& \; g_1(p_1^*, q_1^*) + f_{2}\big(T_{1}(p_1^*, q_1^*)\big) \\
	\stackrel{def}{=}& \; g_1(p_1^*, q_1^*) + f_2(p_2^*) \\
	=& \; g_1(p_1^*, q_1^*) + \max_{q \in Q_{2}(p_2^*)} \Big[g_2(p_2^*, q) + f_{3}\big(T_{2}(p_2^*, q)\big)\Big].
\end{align*}

По построению максимум при $n=2$ происходит при $q = q_2^* = q_2(p_2^*)$, поэтому
\begin{align*}
	f_1(p_0) =& \; g_1(p_1^*, q_1^*) + \max_{q \in Q_{2}(p_2^*)} \Big[g_2(p_2^*, q) + f_{3}\big(T_{2}(p_2^*, q)\big)\Big] \\
	=& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + f_{3}\big(T_{2}(p_2^*, q_2^*)\big) \\
	\stackrel{def}{=}& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + f_3(p_3^*) \\
	=& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + \max_{q \in Q_{3}(p_3^*)} \Big[g_3(p_3^*, q) + f_{4}\big(T_{3}(p_3^*, q)\big)\Big].
\end{align*}

Рассуждая аналогично, можно получить, что
\begin{align*}
	f_1(p_0) =& \; g_1(p_1^*, q_1^*) + g_2(p_2^*, q_2^*) + g_3(p_3^*, q_3^*) + \dots + g_N(p_N^*, q_N^*) \\
	=& \; \sum_{i=1}^N g_i(p_i^*, q_i^*).
\end{align*}

Требуемое доказано, значит исходная стратегия является оптимальной.

\bigskip

\textbf{Итог}

Выбор оптимальной стратегии состоит из двух этапов
\begin{enumerate}[nosep]
	\item заполнение таблицы значениями (справа налево),
	
	\item вычисление оптимальной стратегии по заполненной таблице (слева направо).
\end{enumerate}

\remark

Если в задаче начальное состояние может принимать несколько значений, то нужно осуществить процесс для каждого начального состояния, а потом сравнить полученные результаты и выбрать из них наилучшую стратегию.

\subsection{Решение задачи о машине}

Решим \hyperref[pr:car_on_island]{задачу о машине} с помощью $N$-шагового процесса принятия решения. Немного изменим обозначения исходной задачи. Пусть $i = 1 \dots N$ --- вид детали.

\bigskip

\textit{Параметры}

\begin{itemize}[nosep]
	\item $h_i$ --- масса деталей;
	
	\item $t_i$ --- срок службы деталей;
	
	\item $d_i$ --- количество работающих деталей в машине;
	
	\item $P$ --- максимальная масса посылки.
\end{itemize}

\bigskip

\textit{Переменные}

\begin{itemize}[nosep]	
	\item $x_i$ --- сколько нужно взять деталей в посылку.
\end{itemize}

\bigskip

\textit{$N$-шаговый процесс}

\begin{itemize}[nosep]
	\item \underline{количество шагов процесса} = количество видов деталей = $N$;
	
	\item \underline{на $i$-ом шаге} будем определять, сколько деталей $i$-го типа нужно взять в посылку;
	
	\item \underline{текущее состояние} --- свободная масса груза в посылке, то есть сколько ещё массы можно использовать.
\end{itemize}

\bigskip

Будем рассматривать семейства задач, которые определяются парой $(n, p)$. Фактически это означает, что у нас в распоряжении
\begin{itemize}[nosep]
	\item есть детали не всех видов, а лишь от $n$ до $N$, $n \le N$;
	
	\item есть не вся масса посылки $P$, а лишь её часть $p \le P$.
\end{itemize}

\bigskip

\textbf{База процесса}

Пусть $f_n(p)$ --- максимальное время, которое проработает машина в семействе задач $(n, p)$. Заметим, что если $n = N$, то задача легко решается
\[
\forall p \le P \quad f_N(p) = \bigg(d_N + \bigg[\frac{p}{h_N}\bigg]\bigg) \cdot t_N
\]

В таком случае решение состоит в том, что нужно заказать детали вида $N$ на максимум, то есть сколько можем, столько и заказываем.

\bigskip

\textbf{Переход}

Теперь когда у нас есть база для решения задачи, осуществим переход $f_{n+1}(p) \to f_n(p)$ в предположении, что $f_{n+1}(p)$ мы знаем $\forall p \le P$.
\[
\boxed{f_n(p) = \max_{\stackrel{x = x_n}{h_n \cdot x \le p, \; x \ge 0}} \min\Big\{(d_n + x) \cdot t_n \; ; \; f_{n+1}(p - x \cdot h_n)\Big\}}
\]

$(d_n + x) \cdot t_n$ --- это сколько проработают детали $n$-го вида с учётом уже имеющихся в машине и тех, которые будут заказаны. Для решения задачи нужно для всех $p \le P$ найти значение $f_n(p)$ и соответствующие значения $x$, на которых максимум и достигается.

В исходной формулировке у нас было

\[
f_n(p) = \max_{q \in Q_{n}(p)} \Big[g_n(p, q) + f_{n+1}\big(T_{n}(p, q)\big)\Big].
\]

Отличие в данной задаче состоит в том, что у нас в рекуррентном соотношении не суммирование, а взятие минимума. Теоретически здесь может быть и умножение, но большой роли при решении это не играет. Важно, что рекуррентное соотношение написано.

\bigskip

\textbf{Конкретная задача}

Решим задачу с конкретными числовыми данными

\begin{itemize}[nosep]
	\item $N = 4$;
	
	\item $h = \{3, 2, 3, 2\}$ кг;
	
	\item $t = \{6, 3, 2, 4\}$ дней;
	
	\item $d = \{1.5, 1.5, 1.5, 1.5\}$. $d_i$ = 1.5 может означать, например, что в машине установлены две детали вида $i$, при этом одна отработала половину своего срока, а вторую только недавно установили;
	
	\item $P = 8$ кг.
\end{itemize}

\bigskip

В ходе решения задачи будем заполнять следующую таблицу

\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
		\hline
		0 & & & & \\\hline
		1 & & & & \\\hline
		2 & & & &\\\hline
		3 & & & & \\\hline
		4 & & & & \\\hline
		5 & & & & \\\hline
		6 & & & & \\\hline
		7 & & & & \\\hline
		8 & & & & \\\hline
	\end{tabular}
\end{table}

Таблицу будем заполнять справа налево, запоминая $q_i$ --- то значение $x$, на котором достигается максимум целевой функции.

В левом столбце у нас все возможные состояния $p$, а $p$ --- свободная масса груза в посылке. Заметим, что ни на каком шаге $p$ не может равняться 7, то есть какие бы грузы мы не клали в посылку, свободная масса груза не сможет равняться 7. Это означает, что можно не подсчитывать значения для $p = 7$.

\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
		\hline
		0 & & & & \\\hline
		1 & & & & \\\hline
		2 & & & &\\\hline
		3 & & & & \\\hline
		4 & & & & \\\hline
		5 & & & & \\\hline
		6 & & & & \\\hline
		7 & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
		8 & & & & \\\hline
	\end{tabular}
\end{table}

\begin{enumerate}
	\item[\fbox{\textbf{Шаг 1}}] На первом шаге $n = N = 4$, запишем выражение для $f_4(p)$
	
	\[
	f_4(p) = \bigg(d_n + \bigg[\frac{p}{h_4}\bigg]\bigg) \cdot t_4 = \bigg(1.5 + \bigg[\frac{p}{2}\bigg]\bigg) \cdot 4.
	\]
	
	Таким образом мы можем посчитать значение $f_4(p)$ для любого $p \le P$, при этом нам известно значение, на котором достигается максимум ($q_4$)
	\[
	q_4 = \bigg[\frac{p}{2}\bigg].
	\]
	
	
	Посчитаем значение $f_4$ для всех возможных состояний
	\[
	f_4(0) = 6, \quad q_4 = \bigg[\frac{0}{2}\bigg] = 0;
	\]
	\[
	f_4(1) = 6, \quad q_4 = \bigg[\frac{1}{2}\bigg] = 0;
	\]
	\[
	f_4(2) = 10, \quad q_4 = \bigg[\frac{2}{2}\bigg] = 1;
	\]
	\[
	f_4(3) = 10 \quad q_4 = \bigg[\frac{3}{2}\bigg] = 1;
	\]
	\[
	f_4(4) = 14, \quad q_4 = \bigg[\frac{4}{2}\bigg] = 2;
	\]
	\[
	f_4(5) = 14, \quad q_4 = \bigg[\frac{5}{2}\bigg] = 2;
	\]
	\[
	f_4(6) = 18, \quad q_4 = \bigg[\frac{6}{2}\bigg] = 3;
	\]
	\[
	f_4(8) = 22, \quad q_4 = \bigg[\frac{8}{2}\bigg] = 4.
	\]
	
	Занесём все эти данные в последний столбец таблицы.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & & & & $(6, 0)$ \\\hline
			1 & & & & $(6, 0)$ \\\hline
			2 & & & & $(10, 1)$ \\\hline
			3 & & & & $(10, 1)$ \\\hline
			4 & & & & $(14, 2)$ \\\hline
			5 & & & & $(14, 2)$ \\\hline
			6 & & & & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & & & & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 2}}] На втором шаге $n = 3$. Запишем выражение для $f_3(p)$
	
	\begin{align*}
		f_3(p) =& \max_{\stackrel{x = x_3}{h_3 \cdot x \le p, \; x \ge 0}} \min\Big\{(d_3 + x) \cdot t_3 \; ; \; f_{4}(p - x \cdot h_3)\Big\} \\
		=& \max_{\stackrel{x = x_3}{3x \le p, \; x \ge 0}} \min\Big\{3 + 2x \; ; \; f_{4}(p - 3x)\Big\}
	\end{align*}
	
	На данном шаге нам нужно для всех $0 \le p \le P$ вычислить значение $f_3(p)$ и запомнить значение $x$, на котором достигается максимум в каждом конкретном состоянии. Для каждого состояния мы будем перебирать различные значения $x$. Для примера найдём $f_3(8)$. Для этого нам нужно перебрать значения $x \in \{0, 1, 2\}$, поскольку при $x > 2$ неравенство $3x \le 8$ уже не выполняется, а $x < 0$ нам не подходят по условию. Вычислим значение $\min$ для каждого из этих трёх значений $x$
	
	\[
	x = 0: \quad \min\big\{3 + 2 \cdot 0 \; ; \; f_4(8)\big\} = \min\{3, 22\} = 3
	\]
	\[
	x = 1: \quad \min\big\{3 + 2 \cdot 1 \; ; \; f_4(5)\big\} = \min\{5, 14\} = 5
	\]
	\[
	x = 2: \quad \min\big\{3 + 2 \cdot 2 \; ; \; f_4(2)\big\} = \min\{7, 10\} = \circled{7}
	\]
	
	То есть мы рассмотрели три разных значения $x$ (0, 1, 2), для каждого из них вычислили значение $\min\Big\{(d_n + x) \cdot t_n \; ; \; f_{n+1}(p - x \cdot h_n)\Big\}$, а после этого выбрали из трёх итоговых значение максимальное --- 7, при этом запомнили, что это значение достигается при $x = 2$. Однако данные вычисления можно записать существенно короче
	\[
	f_3(8) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(8) = 22\} = 3 \\
		1 & \{5 \; ; \; f_4(8) = 14\} = 5 \\
		2 & \{7 \; ; \; f_4(8) = 10\} = \circled{7}
	\end{array}
	\]
	
	В первом столбце у нас идут перебираемые значения $x$, а далее для каждого из них вычисление $\min$, само слово <<min>> писать здесь излишне. В кружок обведено значение $\max$. Данной нотации и будем придерживаться всюду далее. Посчитаем $f_3(p)$ для всех $p$
	
	\[
	f_3(0) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(0) = 6\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_3(1) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(1) = 6\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_3(2) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(2) = 10\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_3(3) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(3) = 10\} = 3 \\
		1 & \{5 \; ; \; f_4(0) = 6\} = \circled{5}
	\end{array}
	\]
	
	\[
	f_3(4) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(4) = 14\} = 3 \\
		1 & \{5 \; ; \; f_4(1) = 6\} = \circled{5}
	\end{array}
	\]
	
	\[
	f_3(5) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(5) = 14\} = 3 \\
		1 & \{5 \; ; \; f_4(2) = 10\} = \circled{5}
	\end{array}
	\]
	
	\[
	f_3(6) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(6) = 18\} = 3 \\
		1 & \{5 \; ; \; f_4(3) = 10\} = 5 \\
		2 & \{7 \; ; \; f_4(0) = 6\} = \circled{6}
	\end{array}
	\]
	
	\[
	f_3(8) = \begin{array}{c|l}
		0 & \{3 \; ; \; f_4(8) = 22\} = 3 \\
		1 & \{5 \; ; \; f_4(3) = 10\} = 5 \\
		2 & \{7 \; ; \; f_4(2) = 10\} = \circled{7}
	\end{array}
	\]
	
	Занесём все данные в таблицу. В столбец $(f_3, q_3)$ возле максимального значения, обведённого в кружочек, для каждого состояния $p$ мы ещё записываем значение $x$, в котором достигается максимум. Так, для $f_3(8)$ это $x = 2$, для $f_3(5)$ это $x = 1$ и так далее.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & & & $(3, 0)$ & $(6, 0)$ \\\hline
			1 & & & $(3, 0)$ & $(6, 0)$ \\\hline
			2 & & & $(3, 0)$ & $(10, 1)$ \\\hline
			3 & & & $(5, 1)$ & $(10, 1)$ \\\hline
			4 & & & $(5, 1)$ & $(14, 2)$ \\\hline
			5 & & & $(5, 1)$ & $(14, 2)$ \\\hline
			6 & & & $(6, 2)$ & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & & & $(7, 2)$ & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 3}}] На третьем шаге $n = 2$. Запишем выражение для $f_2(p)$
	
	\begin{align*}
		f_2(p) =& \max_{\stackrel{x = x_2}{h_2 \cdot x \le p, \; x \ge 0}} \min\Big\{(d_2 + x) \cdot t_2 \; ; \; f_{3}(p - x \cdot h_2)\Big\} \\
		=& \max_{\stackrel{x = x_2}{2x \le p, \; x \ge 0}} \min\Big\{4.5 + 3x \; ; \; f_{3}(p - 2x)\Big\}
	\end{align*}
	
	Посчитаем $f_2(p)$ для всех $p$
	
	\[
	f_2(0) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(0) = 3\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_2(1) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(1) = 3\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_2(2) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(2) = 3\} = \circled{3} \\
		1 & \{7.5 \; ; \; f_3(0) = 3\} = \circled{3}
	\end{array}
	\]
	
	\[
	f_2(3) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(3) = 5\} = \circled{4.5} \\
		1 & \{7.5 \; ; \; f_3(1) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(4) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(4) = 5\} = \circled{4.5} \\
		1 & \{7.5 \; ; \; f_3(2) = 3\} = 3 \\
		2 & \{10.5 \; ; \; f_3(0) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(5) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(5) = 5\} = 4.5 \\
		1 & \{7.5 \; ; \; f_3(3) = 5\} = \circled{5} \\
		2 & \{10.5 \; ; \; f_3(1) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(6) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(6) = 6\} = 4.5 \\
		1 & \{7.5 \; ; \; f_3(4) = 5\} = \circled{5} \\
		2 & \{10.5 \; ; \; f_3(2) = 3\} = 3 \\
		3 & \{13.5 \; ; \; f_3(0) = 3\} = 3
	\end{array}
	\]
	
	\[
	f_2(8) = \begin{array}{c|l}
		0 & \{4.5 \; ; \; f_3(8) = 7\} = 4.5 \\
		1 & \{7.5 \; ; \; f_3(6) = 6\} = \circled{6} \\
		2 & \{10.5 \; ; \; f_3(4) = 5\} = 5 \\
		3 & \{13.5 \; ; \; f_3(2) = 3\} = 3 \\
		4 & \{16.5 \; ; \; f_3(0) = 3\} = 3
	\end{array}
	\]
	
	Занесём все данные в таблицу. Заметим, что при вычислении $f_2(2) = 3$ максимум достигается и при $x = 0$, и при $x = 1$. В таблице это будет отражено как $(3, 0/1)$.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			1 & & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			2 & & $(3, 0/1)$ & $(3, 0)$ & $(10, 1)$ \\\hline
			3 & & $(4.5, 0)$ & $(5, 1)$ & $(10, 1)$ \\\hline
			4 & & $(4.5, 0)$ & $(5, 1)$ & $(14, 2)$ \\\hline
			5 & & $(5, 0)$   & $(5, 1)$ & $(14, 2)$ \\\hline
			6 & & $(5, 1)$   & $(6, 2)$ & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & & $(6, 1)$   & $(7, 2)$ & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 4}}] На четвёртом шаге $n = 1$
	
	Наша исходная задача --- это $f_1(8)$, поэтому для всех остальных значений $p \neq 8$ искать $f_1(p)$ не нужно. Запишем выражение для $f_1(8)$
	
	\begin{align*}
		f_1(8) =& \max_{\stackrel{x = x_1}{h_1 \cdot x \le 8, \; x \ge 0}} \min\Big\{(d_1 + x) \cdot t_1 \; ; \; f_{2}(8 - x \cdot h_1)\Big\} \\
		=& \max_{\stackrel{x = x_1}{3x \le 8, \; x \ge 0}} \min\Big\{9 + 6x \; ; \; f_{2}(8 - 3x)\Big\}
	\end{align*}
	
	Посчитаем $f_1(8)$
	\[
	f_1(8) = \begin{array}{c|l}
		0 & \{9 \; ; \; f_2(8) = 6\} = \circled{6} \\
		1 & \{15 \; ; \; f_2(5) = 5\} = 5 \\
		2 & \{21 \; ; \; f_2(2) = 3\} = 5
	\end{array}
	\]
	
	Занесём данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ \\ 
			\hline
			0 & $\times$ & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			1 & $\times$ & $(3, 0)$   & $(3, 0)$ & $(6, 0)$ \\\hline
			2 & $\times$ & $(3, 0/1)$ & $(3, 0)$ & $(10, 1)$ \\\hline
			3 & $\times$ & $(4.5, 0)$ & $(5, 1)$ & $(10, 1)$ \\\hline
			4 & $\times$ & $(4.5, 0)$ & $(5, 1)$ & $(14, 2)$ \\\hline
			5 & $\times$ & $(5, 0)$   & $(5, 1)$ & $(14, 2)$ \\\hline
			6 & $\times$ & $(5, 1)$   & $(6, 2)$ & $(18, 3)$ \\\hline
			7 & $\times$ & $\times$   & $\times$ & $\times$ \\\hline
			8 & $(6, 0)$ & $(6, 1)$   & $(7, 2)$ & $(22, 4)$ \\\hline
		\end{tabular}
	\end{table}
	
	Вспомним, что $f_1(8)$ --- максимальное время работы машины для исходной задачи. Поскольку мы получили, что $f_1(8) = 6$, то в исходной задаче после заказа груза машина проработает ещё 6 дней.
	
	\bigskip
	
	\textbf{Поиск оптимальной стратегии}
	
	Заметим, что наше начальное состояние $p_0 = 8$, поскольку в самом начале нам доступна вся масса груза $P = 8$ кг.
	
	\begin{align*}
		p_1^* = p_0 = 8&, \qquad &q_1^* = 0, \\
		p_2^* = p_1^* - h_1 \cdot q_1^* = 8 &, &q_2^* = 1, \\
		p_3^* = p_2^* - h_2 \cdot q_2^* = 6&, &q_3^* = 2, \\
		p_4^* = p_3^* - h_3 \cdot q_3^* = 0&, &q_4^* = 0.
	\end{align*}
	
	Наша стратегия --- это $q^* = \{0, 1, 2, 0\}$, то есть заказать одну деталь второго типа и две детали третьего типа. При данной стратегии машина проработает ещё $f_1(8) = 6$ дней. При любых других стратегиях время работы будет меньше.
\end{enumerate}

\remark

Чтобы заполнять меньше значений таблицы можно было в начале прибегнуть к оптимизации, посчитав множество возможных состояний для каждого шага. Тогда бы мы считали на шаге $i$ значения $f_i(p)$ не для всех $p \le P$, а лишь для этих самых возможных состояний.

Например, можно заметить, что для подсчёта $f_1(8)$ нам нужно было знать лишь $f_2(8)$, $f_2(5)$ и $f_2(2)$. Значение $f_2(p)$ для остальных $p$ нам в итоге вообще не пригодились.

\subsection{Трудоёмкость алгоритма}\label{n_step_complexity}

Алгоритм выбора оптимальной стратегии $N$-шагового алгоритма состоит из двух этапов: <<обратный ход>> (заполнение таблицы) и <<прямой ход>> (нахождение оптимальной стратегии по заполненной таблице). Осуществить <<прямой ход>> по заполненной таблице не составляет труда, поэтому будем учитывать лишь <<обратный ход>>.

При <<обратном ходе>> у нас есть $N$ шагов, на каждом из которых мы вычисляем значение $f_i(p)$ для всех возможных состояний $p$ на текущем шаге, количество таких состояний равняется $\norm{P_i}$. Для вычисления $f_i(p)$ для каждого конкретного $p$ необходимо осуществить перебор допустимых решений для нахождение максимума/минимума целевой функции, количество допустимых решений на текущем шаге $i$ равняется $\norm{Q_i}$. Таким образом, трудоёмкость алгоритма выбора оптимальной стратегии $N$-шагового процесса в общем случае равняется
\[
\boxed{T = \sum_{i=1}^{N} \norm{P_i} \cdot \norm{Q_i}}
\]

\section{Задача о фермере}

\problem[о фермере]

У фермера имеется стадо коров численностью 50 особей. Увеличение численности стада за год задаётся функцией $\alpha(v)$

\[
\alpha(v) = \begin{cases}
	v + 10,& v \le 70 \\
	v + 20,& \text{иначе}
\end{cases}
\]

Затраты на содержание одной коровы в течение года $d = 0.5$, а выручка от продажи $c = 3$. Фермер составляет план продажи коров на ближайшие 5 лет при условии что численность стада не может быть ниже 50, а продажи производятся в конце года.

\bigskip

\textbf{1. Что будем оптимизировать?} Ответ: фермер должен получить с продажи коров как можно больше денег.

\bigskip

\textbf{2. Что существенно влияет на оптимизируемую характеристику?}

Пусть $i = 1 \dots 5$ --- год.

\bigskip

\textit{Параметры}

\begin{itemize}[nosep]
	\item $d = 0.5$ --- стоимость содержания одной коровы за год;
	
	\item $c = 3$ --- выручка за продажу одной коровы.
\end{itemize}

\bigskip

\textit{Переменные}

\begin{itemize}[nosep]	
	\item $q = \{q_i\}_{i=1}^5$ --- сколько за год нужно продать коров.
\end{itemize}

\bigskip

\textbf{3. Математическая формулировка задачи}

Пусть $G$ --- выручка за 5 лет, а $p = \{p_i\}_{i=1}^5$ --- количество коров в начале года, тогда
\[G = \sum_{i=1}^{5} (\underbrace{c q_i}_{\text{доход}} - \underbrace{d p_i}_{\text{расход}}) \to \max_{q}\]
\[\forall  i \ p_i \ge 50\]
\[p_i = \begin{cases}\tag{*}
	50,& i = 1 \\
	\alpha(p_{i - 1}) - q_{i - 1},& i > 1
\end{cases}
\]

\solution
Для упрощения решения задачи рассмотрим только варианты, когда фермер может продавать за год количество коров кратное 10, то есть
\[
Q_i = \{0, 10, 20, 30, \dots\} \quad i = 1 \dots 5.
\]

Решим задачу с помощью \hyperref[n_step_process]{$N$-шагового процесса принятия решений} с теми же данными, которые были определены в задаче и с учетом условий на $q$

\begin{itemize}[nosep]
	\item \underline{количество шагов процесса} = количество лет = $5$;
	
	\item \underline{на $i$-ом шаге} будем определять сколько коров нужно продать в конце года ($q_i$);
	
	\item \underline{текущее состояние} --- текущее количество коров.
\end{itemize}

Тогда функция $\alpha$ будет от переменной $p_i$

\[
\alpha(p_i) = \begin{cases}
	p_i + 10,& p_i \le 70 \\
	p_i + 20,& \text{иначе}
\end{cases}
\]

Определим \underline{функцию перехода}

\[T_i(p, q) = \alpha(p) - q\]

\bigskip


Определим \underline{множества допустимых состояний} с учётом $(^*)$
\[
P_1 = \{50\}, \quad P_2 = \{50, 60\}, \quad P_3 = \{50, 60, 70\},
\]
\[
P_4 = \{50, 60, 70, 80\}, \quad P_5 = \{50, 60, 70, 80, 90, 100\}
\]

\bigskip

Определим \underline{множество допустимых решений}
\[Q_i(p) = \{q \in Q_i \; \big| \; \alpha(p) - q \ge 50 \}\]

\bigskip

Определим \underline{функцию дохода}
\[g_i(p, q) = -0.5p + 3q = 3q - 0.5p\]

Данная функция обозначает то, сколько денег получит фермер по итогам $i$-го года, если из имеющихся $p$ коров он продаст $q$. 

\bigskip

Для решения будем рассматривать семейства задач, которые определяются парой $(n, p)$. Фактически это означает, что

\begin{itemize}[nosep]
	\item рассматриваем доход за года $n, n+1, \dots, 5$, $n \le 5$;
	
	\item поголовье скота на начало $n$-го года составляет $p \ge 50$ коров.
\end{itemize}

\bigskip

\textbf{База процесса}

Пусть $f_n(p)$ --- максимальная выручка в семействе задач $(n, p)$. Заметим, что если $n = 5$, то задача легко решается: фермеру нужно продать как можно больше коров, но чтобы их осталось не меньше 50
\[
\forall p \in P_5 \quad f_5(p) = \max_{q \in Q_5(p)} \{3q - 0.5p\}.
\]

Поскольку нам выгодно продать как можно больше коров, то нужно взять максимально возможное $q$, но чтобы в конце года коров осталось не меньше 50. Для этого можно взять $q = \alpha(p) - 50$, тогда выражение для $f_5(p)$ в явном виде будет выглядеть так
\[
\forall p \in P_5 \quad f_5(p) = 3(\alpha(p) - 50) - 0.5p.
\]

\bigskip

\textbf{Переход}

Теперь когда у нас есть база для решения задачи, осуществим переход $f_{n+1}(p) \to f_n(p)$ в предположении, что $f_{n+1}(p)$ мы знаем $\forall p \ge 50$.
\[
\boxed{f_n(p) = \max_{q \in Q_n(p)} \Big\{3q - 0.5p + f_{n + 1}(\alpha(p) - q)\Big\}}\tag{**}
\]

Вспомним множества допустимых состояний $P_i$. В объединении всех $P_i$ лежит множество $\{50, 60, 70, 80, 90, 100\}$ --- все значения, которые может принимать $p$. Также понятно, что считать $f_n(p)$ для $p \notin P_n$ не имеет смысла, так как эти состояния недопустимы. Исходя из этого составим следующую таблицу

\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
		\hline
		$50$ & & & & & \\\hline
		$60$ & $\times$ & & & & \\\hline
		$70$ & $\times$ & $\times$ & & & \\\hline
		$80$ & $\times$ & $\times$ & $\times$ & & \\\hline
		$90$ & $\times$ & $\times$ & $\times$ & $\times$ & \\\hline
		$100$ & $\times$ & $\times$ & $\times$ & $\times$ & \\\hline
	\end{tabular}
\end{table}

Значение максимальной выручки в исходной задаче равняется $\mathbf {f_1(50)}$. Заполним таблицу, чтобы найти его, а затем вычислить все $q^*_i$.

\bigskip

\begin{enumerate}
	\item[\fbox{\textbf{Шаг 1}}] На первом шаге $n = 5$, запишем выражение для $f_5(p)$
	
	\[
	f_5(p) = 3(\alpha(p) - 50) - 0.5p.
	\]
	
	Таким образом мы можем посчитать значение $f_5(p)$ для любого $p \ge 50$, при этом нам известно значение, на котором достигается максимум ($q_5$)
	\[
	q_5 = \alpha(p) - 50.
	\]
	
	Посчитаем значение $f_5$ для всех возможных состояний
	\[
	f_5(50) = 3(\alpha(50) - 50) - 50\cdot0.5 = 5, \quad q_5 = \alpha(50) - 50 = 10;
	\]
	\[
	f_5(60) = 3(\alpha(60) - 50) - 60\cdot0.5 = 30, \quad q_5 = \alpha(60) - 50 = 20;
	\]
	\[
	f_5(70) = 3(\alpha(70) - 50) - 70\cdot0.5 = 55, \quad q_5 = \alpha(70) - 50 = 30;
	\]
	\[
	f_5(80) = 3(\alpha(80) - 50) - 80\cdot0.5 = 110, \quad q_5 = \alpha(80) - 50 = 50;
	\]
	\[
	f_5(90) = 3(\alpha(90) - 50) - 90\cdot0.5 = 135, \quad q_5 = \alpha(90) - 50 = 60;
	\]
	\[
	f_5(100) = 3(\alpha(100) - 50) - 100\cdot0.5 = 160, \quad q_5 = \alpha(100) - 50 = 70.
	\]
	
	Занесём все эти данные в последний столбец таблицы.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			50 & & & & & $(5, 10)$ \\\hline
			60 & $\times$ & & & & $(30, 20)$ \\\hline
			70 & $\times$ & $\times$ & & & $(55, 30)$ \\\hline
			80 & $\times$ & $\times$ & $\times$ & & $(110, 50)$ \\\hline
			90 & $\times$ & $\times$ & $\times$ & $\times$ & $(135, 60)$ \\\hline
			100 & $\times$ & $\times$ & $\times$ & $\times$ & $(160, 70)$ \\\hline
		\end{tabular}
	\end{table}
		
	\item[\fbox{\textbf{Шаг 2}}] 
	На втором шаге $n = 4$. Выражение для этого и последующих шагов выглядит как рекуррентное соотношение ($^{**}$).
	
	Делаем вычисления аналогично шагу 2 \hyperref[pr:car_on_island]{решения задачи о машине}, с учетом наших ограничений на $q_i$
	
	\[
	f_4(50) = \begin{array}{c|l}
		0 & -25 + 3 \cdot 0 + f_5(60) = 30 - 25 = 5 \\
		10 & -25 + 3 \cdot 10 + f_5(50) = 30 + 5 - 25 = \circled{10} \\
	\end{array}
	\]
	
	\[
	f_4(60) = \begin{array}{c|l}
		0 & -30 + 3 \cdot 0 + f_5(70) = 55 - 30 = 25 \\
		10 & -30 + 3 \cdot 10 + f_5(60) = 30 + 30 - 30 = 30 \\
		20 & -30 + 3 \cdot 20 + f_5(50) = 60 + 5 - 30 = \circled{35} \\
	\end{array}
	\]
	
	\[
	f_4(70) = \begin{array}{c|l}
		0 & -35 + 3 \cdot 0 + f_5(80) = 110 - 35 = \circled{75} \\
		10 & -35 + 3 \cdot 10 + f_5(70) = 30 + 55 - 35 = 50 \\
		20 & -35 + 3 \cdot 20 + f_5(60) = 60 + 30 - 35 = 55 \\
		30 & -35 + 3 \cdot 30 + f_5(50) = 90 + 5 - 35 = 60 \\
	\end{array}
	\]
	
	\[
	f_4(80) = \begin{array}{c|l}
		0 & -40 + 3 \cdot 0 + f_5(100) = 160 - 40 = 120 \\
		10 & -40 + 3 \cdot 10 + f_5(90) = 30 + 135 - 40 = 125 \\
		20 & -40 + 3 \cdot 20 + f_5(80) = 60 + 110 - 40 = \circled{130} \\
		30 & -40 + 3 \cdot 30 + f_5(70) = 90 + 55 - 40 = 105 \\
		40 & -40 + 3 \cdot 40 + f_5(60) = 120 + 30 - 40 = 110 \\
		50 & -40 + 3 \cdot 50 + f_5(50) = 150 + 5 - 40 = 115 \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			50 & & & & $(10, 10)$ & $(5, 10)$ \\\hline
			60 & $\times$ & & & $(35, 20)$ & $(30, 20)$ \\\hline
			70 & $\times$ & $\times$ & & $(75, 0)$ & $(55, 30)$ \\\hline
			80 & $\times$ & $\times$ & $\times$ & $(130, 20)$ & $(110, 50)$ \\\hline
			90 & $\times$ & $\times$ & $\times$ & $\times$ & $(135, 60)$ \\\hline
			100 & $\times$ & $\times$ & $\times$ & $\times$ & $(160, 70)$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 3}}] На третьем шаге $n = 3$. Считаем значения для $f_3(p)$
	
	\[
	f_3(50) = \begin{array}{c|l}
		0 & -25 + 3 \cdot 0 + f_4(60) = 35 - 25 = 10 \\
		10 & -25 + 3 \cdot 10 + f_4(50) = 30 + 10 - 25 = \circled{15} \\
	\end{array}
	\]
	
	\[
	f_3(60) = \begin{array}{c|l}
		0 & -30 + 3 \cdot 0 + f_4(70) = 75 - 30 = \circled{45} \\
		10 & -30 + 3 \cdot 10 + f_4(60) = 35 + 30 - 30 = 35 \\
		20 & -30 + 3 \cdot 20 + f_4(50) = 60 + 10 - 30 = 40 \\
	\end{array}
	\]
	
	\[
	f_3(70) = \begin{array}{c|l}
		0 & -35 + 3 \cdot 0 + f_4(80) = 130 - 35 = \circled{95} \\
		10 & -35 + 3 \cdot 10 + f_4(70) = 30 + 75 - 35 = 90 \\
		20 & -35 + 3 \cdot 20 + f_4(60) = 60 + 35 - 35 = 60 \\
		30 & -35 + 3 \cdot 30 + f_4(50) = 90 + 10 - 35 = 65 \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			50 & & & $(15, 10)$ & $(10, 10)$ & $(5, 10)$ \\\hline
			60 & $\times$ & & $(45, 0)$ & $(35, 20)$ & $(30, 20)$ \\\hline
			70 & $\times$ & $\times$ & $(95, 0)$ & $(75, 0)$ & $(55, 30)$ \\\hline
			80 & $\times$ & $\times$ & $\times$ & $(130, 20)$ & $(110, 50)$ \\\hline
			90 & $\times$ & $\times$ & $\times$ & $\times$ & $(135, 60)$ \\\hline
			100 & $\times$ & $\times$ & $\times$ & $\times$ & $(160, 70)$ \\\hline
		\end{tabular}
	\end{table}
	
		\item[\fbox{\textbf{Шаг 4}}] На четвертом шаге $n = 2$. Считаем значения для $f_2(p)$
	
	\[
	f_2(50) = \begin{array}{c|l}
		0 & -25 + 3 \cdot 0 + f_3(60) = 45 - 25 = \circled{20} \\
		10 & -25 + 3 \cdot 10 + f_3(50) = 30 + 15 - 25 = \circled{20} \\
	\end{array}
	\]
	
	\[
	f_2(60) = \begin{array}{c|l}
		0 & -30 + 3 \cdot 0 + f_3(70) = 95 - 30 = \circled{65} \\
		10 & -30 + 3 \cdot 10 + f_3(60) = 45 + 30 - 30 = 45 \\
		20 & -30 + 3 \cdot 20 + f_3(50) = 60 + 15 - 30 = 45 \\
	\end{array}
	\]
	
	Занесём все данные в таблицу. Заметим, что при вычислении $f_2(50) = 20$ максимум достигается и при $q = 0$, и при $q = 10$. В таблице это будет отражено как $(20, 0/10)$.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			50 & & $(20, 0/10)$ & $(15, 10)$ & $(10, 10)$ & $(5, 10)$ \\\hline
			60 & $\times$ & $(65, 0)$ & $(45, 0)$ & $(35, 20)$ & $(30, 20)$ \\\hline
			70 & $\times$ & $\times$ & $(95, 0)$ & $(75, 0)$ & $(55, 30)$ \\\hline
			80 & $\times$ & $\times$ & $\times$ & $(130, 20)$ & $(110, 50)$ \\\hline
			90 & $\times$ & $\times$ & $\times$ & $\times$ & $(135, 60)$ \\\hline
			100 & $\times$ & $\times$ & $\times$ & $\times$ & $(160, 70)$ \\\hline
		\end{tabular}
	\end{table}
	
		\item[\fbox{\textbf{Шаг 5}}] На пятом шагу $n = 1$. Считаем значения для $f_1(p)$
	
	\[
	f_1(50) = \begin{array}{c|l}
		0 & -25 + 3 \cdot 0 + f_2(60) = 65 - 25 = \circled{40} \\
		10 & -25 + 3 \cdot 10 + f_2(50) = 30 + 20 - 25 = 25 \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			50 & $(40, 0)$ & $(20, 0/10)$ & $(15, 10)$ & $(10, 10)$ & $(5, 10)$ \\\hline
			60 & $\times$ & $(65, 0)$ & $(45, 0)$ & $(35, 20)$ & $(30, 20)$ \\\hline
			70 & $\times$ & $\times$ & $(95, 0)$ & $(75, 0)$ & $(55, 30)$ \\\hline
			80 & $\times$ & $\times$ & $\times$ & $(130, 20)$ & $(110, 50)$ \\\hline
			90 & $\times$ & $\times$ & $\times$ & $\times$ & $(135, 60)$ \\\hline
			100 & $\times$ & $\times$ & $\times$ & $\times$ & $(160, 70)$ \\\hline
		\end{tabular}
	\end{table}
	
	\bigskip
	
	\textbf{Поиск оптимальной стратегии}
	
	Заметим, что наше начальное состояние $p_0 = 50$, поскольку в самом начале у фермера было 50 коров
	
	\begin{alignat*}{2}
		p_1^* = p_0 = 50&, \qquad\qquad &&q_1^* = 0, \\
		p_2^* = \alpha(p_1^*) - q^*_1 = 60 &, &&q_2^* = 0, \\
		p_3^* = \alpha(p_2^*) - q^*_2 = 70 &, &&q_3^* = 0, \\
		p_4^* = \alpha(p_3^*) - q^*_3 = 80 &, &&q_4^* = 20, \\
		p_5^* = \alpha(p_4^*) - q^*_4 = 80 &, &&q_5^* = 50.
	\end{alignat*}
	
	Итоговая стратегия --- это $q^* = \{0, 0, 0, 20, 50\}$, то есть в первые три года не продавать коров, в четвёртый год продать 20, а в пятый --- 50. При данной стратегии прибыль составит $f_1(50) = 40$.
\end{enumerate}

\section{Задача о подрядчике}

\problem[о подрядчике]

Строительный подрядчик оценивает потребность в количестве рабочей силы на каждую из последующих пяти недель как 5, 7, 8, 4 и 6 рабочих. Подрядчик может нанимать и увольнять рабочих в начале недели, исходя из того, что содержание избыточной рабочей силы обходится в 3 у.е. на одного рабочего в неделю, выплата выходного пособия для увольнения равна 2 у.е., а наем рабочей силы обходится в 4 у.е (за вход на рабочую биржу) и по 2 у.е. за каждого нанятого работника.
Чему равны наименьшие затраты на найм, содержание избыточных и увольнение рабочих, если на момент начала первой недели у подрядчика не было ни одного рабочего?

\bigskip

\textbf{1. Что будем оптимизировать?} Ответ: Подрядчик должен потратить как можно меньше денег, при этом количества рабочих должно хватать для выполнения плана для каждой недели.

\bigskip

\textbf{2. Что существенно влияет на оптимизируемую характеристику?}

Пусть $i = 1 \dots 5$ --- неделя.
Отметим как $\lambda_i$ количество рабочих, необходимое для работы на $i$-ой неделе.

\begin{table}[h!]
	\centering
	\begin{tabular}{| c | c | c | c | c | c |} 
		\hline
		\textbf{Неделя ($i$)}             & $1$ & $2$ & $3$ & $4$ & $5$ \\\hline
		\textbf{Количество рабочих ($\lambda_i$)}              & 5   & 7   & 8   & 4   & 6 \\\hline
	\end{tabular}
\end{table}

\bigskip

\textit{Параметры}

\begin{itemize}[nosep]
	\item $e = 4$ --- стоимость входа на биржу;
	
	\item $c = 2$ --- стоимость найма рабочего;
	
	\item $u = 2$ --- выплата выходного пособия для увольнения;
	
	\item $d = 3$ --- выплата за одного избыточного рабочего. 
\end{itemize}

\bigskip

\textit{Переменные}

\begin{itemize}[nosep]	
	\item $q = \{q_i\}_{i=1}^5$ --- сколько нужно нанять рабочих в начале $i$-ой недели. Может быть отрицательным (увольняем) или равно 0 (ничего не делаем) $q_i \in Q_i = \{\underbrace{\dots, -2, -1,}_{\text{увольняем}} 0, \underbrace{1, 2, \dots}_{\text{нанимаем}}\}$
\end{itemize}

\bigskip

\textbf{3. Математическая формулировка задачи}

Пусть $G$ --- затраты за 5 недель, а $p = \{p_i\}_{i=1}^5$ --- количество рабочих в начале недели, тогда
\[G = \sum_{i=1}^{5}  \begin{cases}
	e + cq_i + d(p_i + q_i - \lambda_i),& q_i > 0, \\
	d(p_i + q_i - \lambda_i),& q_i = 0, \\
	-uq_i + d(p_i + q_i - \lambda_i),& q_i < 0. \\
\end{cases}\]

\[G \to \min_{q}\]

\[\forall  i \ p_i + q_i \ge \lambda_i \tag{*}\]

\solution
Решим задачу с помощью \hyperref[n_step_process]{$N$-шагового процесса принятия решений} с теми же данными, которые были определены в задаче и с учетом условий на $q$

\begin{itemize}[nosep]
	\item \underline{количество шагов процесса} = количество недель = $5$;
	
	\item \underline{на $i$-ом шаге} будем определять сколько нужно нанять/уволить рабочих в начале недели ($q_i$);
	
	\item \underline{текущее состояние} --- текущее количество рабочих.
\end{itemize}

\bigskip

Определим \underline{функцию перехода}

\[T_i(p, q) = p + q\]

\bigskip

Определим \underline{множества допустимых состояний} с учетом того, что на i-ой неделе подрядчику нужно минимум $\lambda_i$ рабочих, а также того, что нет смысла нанимать свыше $\max (\lambda)$ рабочих, при этом в начале было 0 рабочих.
\[
P_1 = \{0\}, \quad P_2 = \{5, 6, 7, 8\}, \quad P_3 = \{7, 8\},
\]
\[
P_4 = \{8\}, \quad P_5 = \{4, 5, 6\}, \quad P_6 = \{6\}
\]

Состояние $P_6$ фиктивное, оно необходимо, чтобы указать что на 5-ой неделе должно после выполнения шага остаться 6 рабочих. 

\bigskip

Определим \underline{множество допустимых решений} с учётом $(^*)$ 
\[Q_i(p) = \{q \in Q_i \; \big| \; \underbrace{T_n(p, q)}_{p + q} \in P_{i + 1} \}\]
\bigskip

Определим \underline{функцию расхода}
\[g_i(p,q) = \begin{cases}
	4 + 2q + 3(p + q - \lambda_i),& q > 0, \\
	3(p + q - \lambda_i),& q = 0, \\
	-2q + 3(p + q - \lambda),& q < 0. \\
\end{cases}\]

Данная функция обозначает то, сколько денег потратит подрядчик в начале $i$-ой недели, если при имеющихся $p$ рабочих он наймет $q$. 

\bigskip

Для решения будем рассматривать семейства задач, которые определяются парой $(n, p)$. Фактически это означает, что

\begin{itemize}[nosep]
	\item рассматриваем расход за недели $n, n+1, \dots, 5$, $n \le 5$;
	
	\item количество рабочих на начало $n$-ой недели составляет $p \ge \begin{cases}
		\lambda_{n - 1},& n > 1, \\
		 0& n = 0. \\
	\end{cases}$.
\end{itemize}

\bigskip

\textbf{База процесса}

Пусть $f_n(p)$ --- минимальные затраты в семействе задач $(n, p)$. Заметим, что если $n = 5$, то задача легко решается: подрядчику нужно нанять/уволить столько рабочих, чтобы их стало ровно $\lambda_5 = 6$ т.е. $q_5(p) = 6 - p$
\[
\forall p \in P_5 \quad f_5(p) = g_5(p, 6 - p).
\]


\bigskip

\textbf{Переход}

Теперь когда у нас есть база для решения задачи, осуществим переход $f_{n+1}(p) \to f_n(p)$ в предположении, что $f_{n+1}(p)$ мы знаем $\forall p \ge \lambda_{n - 1}$.
\[
\boxed{f_n(p) = \min_{q \in Q_n(p)} \Big\{ g_n(p, q) + f_{n + 1}(\underbrace{T_n(p, q)}_{p + q}) \Big\}}\tag{**}
\]

Вспомним множества допустимых состояний $P_i$. В объединении всех $P_i$ лежит множество $\{0, 4, 5, 6, 7, 8\}$ --- все значения, которые может принимать $p$. Также понятно, что считать $f_n(p)$ для $p \notin P_n$ не имеет смысла, так как эти состояния недопустимы. Исходя из этого составим следующую таблицу

\begin{table}[H]
	\centering
	\begin{tabular}{ | c | c | c | c | c | c | } 
		\hline
		$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
		\hline
		$0$ & & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
		$4$ & $\times$ & $\times$ & $\times$ & $\times$ & \\\hline
		$5$ & $\times$ & & $\times$ & $\times$ & \\\hline
		$6$ & $\times$ & & $\times$ & $\times$ & \\\hline
		$7$ & $\times$ & & & $\times$ & $\times$ \\\hline
		$8$ & $\times$ & & & & $\times$ \\\hline
	\end{tabular}
\end{table}

Значение минимального расхода в исходной задаче равняется $\mathbf {f_1(0)}$. Заполним таблицу, чтобы найти его, а затем вычислить все $q^*_i$.

\bigskip

\begin{enumerate}
	\item[\fbox{\textbf{Шаг 1}}] На первом шаге $n = 5$, запишем выражение для $f_5(p)$ с учетом того что $q_5(p) = 6 - p$
	
	\[
	f_5(p) = g_5(p, 6 - p),
	\]
	
	Посчитаем значение $f_5$ для всех возможных состояний
	\[
	f_5(4) = g_5(4, 2) = 4 + 2\cdot2 + 3(4 + 2 - 6) = 8;
	\]
	\[
	f_5(5) = g_5(5, 1) = 4 + 2\cdot1 + 3(5 + 1 - 6) = 6;
	\]
	\[
	f_5(6) = g_5(6, 0) = 3(6 + 0 - 6) = 0;
	\]
	
	Занесём все эти данные в последний столбец таблицы.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			$0$ & & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
			$4$ & $\times$ & $\times$ & $\times$ & $\times$ & $(8, 2)$ \\\hline
			$5$ & $\times$ & & $\times$ & $\times$ & $(6, 1)$ \\\hline
			$6$ & $\times$ & & $\times$ & $\times$ & $(0, 0)$ \\\hline
			$7$ & $\times$ & & & $\times$ & $\times$ \\\hline
			$8$ & $\times$ & & & & $\times$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 2}}] На втором шаге $n = 4$. Выражение для этого и последующих шагов выглядит как рекуррентное соотношение ($^{**}$).
	
	\[
	f_4(8) = \begin{array}{c|l}
		-4 & g_4(8, -4) + f_5(4) = 2\cdot4 + 3(8 - 4 - 4) + 8 = 16 \\
		-3 & g_4(8, -3) + f_5(5) = 2\cdot3 + 3(8 - 3 - 4) + 6 = 15 \\
		-2 & g_4(8, -2) + f_5(6) = 2\cdot2 + 3(8 - 2 - 4) + 0 = \circled{10} \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			$0$ & & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
			$4$ & $\times$ & $\times$ & $\times$ & $\times$ & $(8, 2)$ \\\hline
			$5$ & $\times$ & & $\times$ & $\times$ & $(6, 1)$ \\\hline
			$6$ & $\times$ & & $\times$ & $\times$ & $(0, 0)$ \\\hline
			$7$ & $\times$ & & & $\times$ & $\times$ \\\hline
			$8$ & $\times$ & & & $(10, -2)$ & $\times$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 3}}] На третьем шаге $n = 3$. Считаем значения для $f_3(p)$
	
	\[
	f_3(8) = \begin{array}{c|l}
		0 & g_3(8, 0) + f_4(8) = 0 + 10 = \circled{10} \\
	\end{array}
	\]
	
	\[
	f_3(7) = \begin{array}{c|l}
		1 & g_3(7, 1) + f_4(8) = 4 + 2 + 10 = \circled{16} \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			$0$ & & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
			$4$ & $\times$ & $\times$ & $\times$ & $\times$ & $(8, 2)$ \\\hline
			$5$ & $\times$ & & $\times$ & $\times$ & $(6, 1)$ \\\hline
			$6$ & $\times$ & & $\times$ & $\times$ & $(0, 0)$ \\\hline
			$7$ & $\times$ & & $(16, 1)$ & $\times$ & $\times$ \\\hline
			$8$ & $\times$ & & $(10, 0)$ & $(10, -2)$ & $\times$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 4}}] На четвертом шаге $n = 2$. Считаем значения для $f_2(p)$
	
	\[
	f_2(5) = \begin{array}{c|l}
		2 & g_2(5, 2) + f_3(7) = 4 + 2\cdot2 + 3(5 + 2 - 7) + 16 = 24 \\
		3 & g_2(5, 3) + f_5(8) = 4 + 2\cdot2 + 3(5 + 3 - 7) + 10 = \circled{23} \\
	\end{array}
	\]
	
	\[
	f_2(6) = \begin{array}{c|l}
		1 & g_2(6, 1) + f_3(7) = 4 + 2\cdot1 + 3(6 + 1 - 7) + 16 = 22 \\
		2 & g_2(6, 2) + f_5(8) = 4 + 2\cdot2 + 3(6 + 2 - 7) + 10 = \circled{21} \\
	\end{array}
	\]
	
	\[
	f_2(7) = \begin{array}{c|l}
		0 & g_2(7, 0) + f_3(7) = 3(7 + 0 - 7) + 16 = \circled{16} \\
		1 & g_2(7, 1) + f_5(8) = 4 + 2\cdot1 + 3(7 + 1 - 7) + 10 = 19 \\
	\end{array}
	\]
	
	\[
	f_2(8) = \begin{array}{c|l}
		0 & g_2(8, 0) + f_3(8) = 3(8 + 0 - 7) + 10 = \circled{13} \\
		-1 & g_2(8, -1) + f_5(7) = 2\cdot1 + 3(8 - 1 - 7) + 16 = 18 \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			$0$ & & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
			$4$ & $\times$ & $\times$ & $\times$ & $\times$ & $(8, 2)$ \\\hline
			$5$ & $\times$ & $(23, 3)$ & $\times$ & $\times$ & $(6, 1)$ \\\hline
			$6$ & $\times$ & $(21, 2)$ & $\times$ & $\times$ & $(0, 0)$ \\\hline
			$7$ & $\times$ & $(16, 0)$ & $(16, 1)$ & $\times$ & $\times$ \\\hline
			$8$ & $\times$ & $(13, 0)$ & $(10, 0)$ & $(10, -2)$ & $\times$ \\\hline
		\end{tabular}
	\end{table}
	
	\item[\fbox{\textbf{Шаг 5}}] На пятом шагу $n = 1$. Считаем значения для $f_1(p)$
	
	\[
	f_1(0) = \begin{array}{c|l}
		5 & g_1(5, 0) + f_2(5) = 4 + 2\cdot5 + 3(5 + 0 - 5) + 23 = \circled{37}  \\
		6 & g_1(5, 1) + f_2(6) = 4 + 2\cdot6 + 3(6 + 0 - 5) + 21 = 40  \\
		7 & g_1(5, 2) + f_2(7) = 4 + 2\cdot7 + 3(7 + 0 - 5) + 16 = 40  \\
		8 & g_1(5, 3) + f_2(8) = 4 + 2\cdot8 + 3(8 + 0 - 5) + 13 = 42  \\
	\end{array}
	\]
	
	Занесём все данные в таблицу.
	
	\begin{table}[H]
		\centering
		\begin{tabular}{ | c | c | c | c | c | c | } 
			\hline
			$p$ & $(f_1, q_1)$ & $(f_2, q_2)$ & $(f_3, q_3)$ & $(f_4, q_4)$ & $(f_5, q_5)$ \\ 
			\hline
			$0$ & $(37, 5)$ & $\times$ & $\times$ & $\times$ & $\times$ \\\hline
			$4$ & $\times$ & $\times$ & $\times$ & $\times$ & $(8, 2)$ \\\hline
			$5$ & $\times$ & $(23, 3)$ & $\times$ & $\times$ & $(6, 1)$ \\\hline
			$6$ & $\times$ & $(21, 2)$ & $\times$ & $\times$ & $(0, 0)$ \\\hline
			$7$ & $\times$ & $(16, 0)$ & $(16, 1)$ & $\times$ & $\times$ \\\hline
			$8$ & $\times$ & $(13, 0)$ & $(10, 0)$ & $(10, -2)$ & $\times$ \\\hline
		\end{tabular}
	\end{table}
	
	\bigskip
	
	\textbf{Поиск оптимальной стратегии}
	
	Заметим, что наше начальное состояние $p_0 = 0$, поскольку в самом начале было 0 рабочих
	
	\begin{alignat*}{2}
		p_1^* = p_0 = 0&, \qquad\qquad &&q_1^* = 5, \\
		p_2^* = p_1^* + q^*_1 = 5 &, &&q_2^* = 3, \\
		p_3^* = p_2^* + q^*_2 = 8 &, &&q_3^* = 0, \\
		p_4^* = p_3^* + q^*_3 = 8 &, &&q_4^* = -2, \\
		p_5^* = p_4^* + q^*_4 = 6 &, &&q_5^* = 0.
	\end{alignat*}
	
	Итоговая стратегия --- это $q^* = \{5, 3, 0, 0, -2\}$, то есть в начале 1-ой недели нанимаем 5 рабочих, на следующей еще 3, на третьей ничего не делаем, а на четвертой увольняем 2-их рабочих, на последней неделе ничего не делаем. При данной стратегии расход составит $f_1(0) = 37$.
\end{enumerate}

\section{Распределительная задача}

\problem[распределительная]

Распределительная задача обобщает \hyperref[pr:car_on_island]{задачу о машине} и \hyperref[pr:loading_vessel]{задачу загрузки судна}. В общем случае задача формулируется следующим образом

\begin{itemize}[nosep]
	\item имеется ограниченный ресурс в количестве $b$;
	
	\item ресурс можно потратить $N$ способами;
	
	\item $x = 0, 1, 2, \dots$ --- интенсивность использования ресурса;
	
	\item $h_i(x)$ --- затраты ресурса при использовании его $i$-ым способом с интенсивностью $x$;
	
	\item $c_i(x)$ --- прибыль/убыток при использовании ресурса $i$-ым способом с интенсивностью $x$;
	
	\item $h_i(x)$ и $c_i(x)$ --- возрастающие функции, при этом $c_i(0) = h_i(0) = 0$.
\end{itemize}

\[
\sum_{i=1}^{N}c_i(x) \to \underset{(x_i)}{\substack{\max \\ \min}}
\]
\[
\sum_{i=1}^{N} h_i(x_i) \le b,
\]
\[
x_i \le a_i \quad i = 1 \dots N.
\]

\solution

Покажем, что исходная задача ($\P$) сводится к \hyperref[n_step_process]{задаче выбора оптимальной стратегии $N$-шагового процесса} ($\Q$), то есть что распределительную задачу можно решить данным способом.

\bigskip

\textbf{$N$-шаговый процесс}

\begin{itemize}[nosep]
	\item \underline{количество шагов} = $N$;
	
	\item \underline{состояние} на каждом шаге --- сколько ресурса можно израсходовать;
	
	\item \underline{решение} на каждом шаге --- интенсивность использования ресурса;
	
	\item \underline{допустимые состояния}
	\[
	P_1 = \{b\},
	\]
	\[
	P_i = \{0, \dots, b\}, \quad i = 2 \dots N+1;
	\]
	
	\item \underline{допустимые решения}
	\[
	Q_i = \{0, \dots, a_i\}, \quad i = 1 \dots N;
	\]
	
	\item \underline{функция перехода}
	\[
	T_i(p, q) = p - h_i(q), \quad i = 1 \dots N;
	\]
	
	\item \underline{целевая функция}
	\[
	g_i(p, q) = c_i(q), \quad i = 1 \dots N.
	\]
\end{itemize}

\bigskip

\textbf{Сведение к задаче выбора оптимальной стратегии}

Для сведения исходной задачи $\P$ к задаче $\Q$ нужно

\begin{enumerate}[nosep]
	\item по исходным данным задачи $\P$ построить исходные данные задачи $\Q$;
	
	\item по оптимальной стратегии задачи $\Q$ построить оптимальное решение задачи $\P$.
\end{enumerate}

Пусть $q^* = \{q_1^*, q_2^*, \dots, q_N^*\}$ --- оптимальная стратегии задачи $\Q$, тогда решение для исходной задачи $\P$ выглядит следующим образом

\[
x^0 = (x_i^0), \quad x_i^0 = q_i^*.
\]

Таким образом, первое уже сделано, а для второго нужно доказать, что $x^0$ --- допустимое и оптимальное решение задачи $\P$.

\bigskip

\textit{Доказательство допустимости}

\begin{itemize}[nosep]
	\item $q_i^* \le a_i$, поэтому из определения $x_i^0$ следует, что \fbox{$x_i^0 \le a_i$}.
		
	\item Пусть $p_i^*$ --- состояние на $i$-ом шаге, если следовать оптимальной стратегии $q^*$.  Из выражения для множеств допустимых состояний следует, что $p_{N+1}^* \ge 0$, из выражения для функции перехода следует, что $p_{i+1}^* = p_i^* - h_i (q_i^*)$. Распишем имеющие неравенства
	\begin{align*}
		0 \le& \; p_{N+1}^* = p_N^* - h_N (q_N^*) \\
		=& \; \big(p_{N-1}^* - h_{N-1}(q_{N-1}^*)\big) - h_N (q_N^*) \\
		=& \; \dots \\
		=& \; -\sum_{i=1}^N h_i(q_i^*) + p_1^* \\
		\stackrel{P_1=\{b\}}{=}& -\sum_{i=1}^N h_i(q_i^*) + b \\
		=& \; b - \sum_{i=1}^N h_i(q_i^*),
	\end{align*}
	
	то есть
	\[0 \le b - \sum_{i=1}^N h_i(q_i^*),\]
	\[\boxed{\sum_{i=1}^N h_i(q_i^*) \le b}.\]
\end{itemize}

Таким образом, мы доказали, что $x^0$ --- допустимое решение задачи $\P$, так как оно удовлетворяет всем ограничениям задачи $\P$.

\bigskip

\textit{Доказательство оптимальности}

Заметим, что целевые функции в задачах $\P$ и $\Q$ одни и те же, поэтому нетрудно показать, что по \hyperref[fact:reduction_to_other_problem]{утверждению 3} решение исходной задачи $x^0$, построенное на оптимальной стратегии $q^*$, будет оптимальным.

Таким образом, задача $\P$ действительно сводится к задаче $\Q$.

\bigskip

\textbf{Выбор оптимальной стратегии}

Определим множество допустимых решений на шаге $i$ в состоянии $p$
\[
Q_i(p) = \{q \in Q_i \; \big| \; T_i(p, q) \in P_{i+1}\}, \quad i = 1 \dots N.
\]

Вспомним, что $q = 0, 1, \dots a$, то есть $\boxed{0 \le q \le a_i}$. Распишем функцию перехода
\[
T_i(p, q) \in P_{i+1}
\]
\[
\Updownarrow
\]
\[
0 \le p - h_i(q) \le b \quad \Longrightarrow \quad \boxed{h_i(q) \le p}.
\]

Таким образом, решение $q$ на $i$-ом шаге в состоянии $p$ является допустимым тогда и только когда, когда
\[
\begin{cases}
	0 \le q \le a_i, \\
	h_i(q) \le p.
\end{cases}
\]

\bigskip

\textit{База процесса}

Пусть $p \in P_N$, запишем выражение для $f_N(p)$

\[
f_N(p) = \max_{q \in Q_N(p)} \{c_N(q).\}
\]

Вспомним, что $\{c_i(x)\}$ --- возрастающие функции, поэтому максимум $c_N(q)$ достигается при $q_{\max} \in Q_N(p)$. Таким образом
\[
f_N(p) = c_N(q_{\max}),
\]

при $q_{\max}$, которое удовлетворяют ограничениям
\[
\begin{cases}
	0 \le q \le a_i, \\
	h_i(q) \le p.
\end{cases}
\]

\bigskip

\textit{Переход}

Пусть $n = 1 \dots N-1$, $p \in P_n$, запишем выражение для $f_n(p)$
\[
f_n(p) = \max_{q \in Q_n(p)} \big\{c_n(q) + f_{n+1}\big(\underbrace{T_i(p, q)}_{p - h_n(q)}\big)\big\},
\]
\[
q \in Q_n(p) \quad \Longleftrightarrow \quad \begin{cases}
	0 \le q \le a_i, \\
	h_i(q) \le p.
\end{cases}
\]

\bigskip

\textbf{Трудоёмкость}

Напишем выражение \hyperref[n_step_complexity]{трудоёмкости алгоритма выбора оптимальной стратегии $N$-шагового процесса}
\[
T = N \cdot b \cdot a.
\]

\begin{itemize}[nosep]
	\item $N$ --- число шагов алгоритма;
	
	\item $b$ --- количество возможных состояний на каждом шаге;
	
	\item $a = \max\{a_1, a_2, \dots, a_N\}$ --- количество перебираемых решений на каждом шаге для каждого состояния.
\end{itemize}

Напишем выражение оценки трудоёмкости через длину входа задачи. Для хранения условия задачи в памяти нужно хранить значения всех констант и всех функций во всех возможных точках. Будем учитывать лишь хранение значений функций, поскольку занимаемый объём памяти для всего остального можно оценить как $\O(1)$. В данной задаче у нас есть функции $\{c_i(x)\}_{i=1}^N$ и $\{h_i(x)\}_{i=1}^N$, при этом каждая функция определена в $a$ точках. Занимаемый объём памяти функциями составляет $2 \cdot N \cdot a$, запишем это так
\[
\abs{p} = \O(N \cdot a),
\]

значит
\[
T = N \cdot b \cdot a = b \cdot N \cdot a \le b \cdot \abs{p}.
\]

Таким образом,
\[
\boxed{T(\abs{p}) \le b \cdot \abs{p}}
\]

\remark

Нельзя написать, что
\[
T\big(\abs{p}\big) \le C \cdot \abs{p}
\]

так как нет такой константы $C$, чтобы неравенство выполнялась для любой задачи, относящейся к распределительной, поскольку какое бы $C$ мы не взяли, всегда можно написать распределительную задачу, в которой $b = C + 1$. Таким образом, алгоритм решения распределительной задачи с помощью выбора оптимальной стратегии $N$-шагового процесса не является полиномиальным (он является \definitionfont{псевдополиномиальным}).

\subsection{Задача о рюкзаке}

\section{Задача о ближайшем соседе}
